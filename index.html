<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="zhanglu的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="zhanglu的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zhanglu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>zhanglu的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">zhanglu的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/%E8%8E%B7%E5%8F%96%E7%9C%9F%E5%AE%9EIP%E5%B7%A5%E5%85%B7%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/%E8%8E%B7%E5%8F%96%E7%9C%9F%E5%AE%9EIP%E5%B7%A5%E5%85%B7%E7%B1%BB/" class="post-title-link" itemprop="url">获取真实IP工具类</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-16 19:43:17" itemprop="dateCreated datePublished" datetime="2020-04-16T19:43:17+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="获取真实IP工具类"><a href="#获取真实IP工具类" class="headerlink" title="获取真实IP工具类"></a>获取真实IP工具类</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.idatage.cloud.wenjuan.que.api.v1.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取IP地址 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 使用Nginx等反向代理软件， 则不能通过request.getRemoteAddr()获取IP地址</span></span><br><span class="line"><span class="comment">     * 如果使用了多级反向代理的话，X-Forwarded-For的值并不止一个，而是一串IP地址，X-Forwarded-For中第一个非unknown的有效IP字符串，则为真实IP地址</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getIpAddr</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String ip = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ip = request.getHeader("X-Real-IP");</span></span><br><span class="line">            <span class="keyword">if</span> (checkIp(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">"x-forwarded-for"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkIp(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">"Proxy-Client-IP"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkIp(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">"WL-Proxy-Client-IP"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkIp(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">"HTTP_CLIENT_IP"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkIp(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkIp(ip)) &#123;</span><br><span class="line">                ip = request.getRemoteAddr();</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"127.0.0.1"</span>.equals(ip) || <span class="string">"0:0:0:0:0:0:0:1"</span>.equals(ip)) &#123;</span><br><span class="line">                    <span class="comment">// 根据网卡取本机配置的IP</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">                        log.error(<span class="string">"InetAddress.getLocalHost()-error, &#123;&#125;"</span>, e.getMessage());</span><br><span class="line">                        ip = <span class="string">""</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"IPUtils ERROR, &#123;&#125;"</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用代理，则获取第一个IP地址</span></span><br><span class="line">        <span class="keyword">if</span>(ip!=<span class="keyword">null</span> &amp;&amp; ip.indexOf(<span class="string">","</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ip = ip.substring(<span class="number">0</span>, ip.indexOf(<span class="string">","</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkIp</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">        String unknown = <span class="string">"unknown"</span>;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.isEmpty(ip) || ip.length() == <span class="number">0</span> || unknown.equalsIgnoreCase(ip);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/14/RocketMQ%E7%AE%80%E4%BB%8B+rocketMq%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/14/RocketMQ%E7%AE%80%E4%BB%8B+rocketMq%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7/" class="post-title-link" itemprop="url">RocketMQ简介+rocketMq解决消息幂等性</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-14 20:40:12" itemprop="dateCreated datePublished" datetime="2020-04-14T20:40:12+08:00">2020-04-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="RocketMQ简介-rocketMq解决消息幂等性"><a href="#RocketMQ简介-rocketMq解决消息幂等性" class="headerlink" title="RocketMQ简介+rocketMq解决消息幂等性"></a><strong>RocketMQ</strong>简介+rocketMq解决消息幂等性</h1><h2 id="RocketMQ概述"><a href="#RocketMQ概述" class="headerlink" title="RocketMQ概述"></a>RocketMQ概述</h2><p>RocketMQ 是一款分布式、队列模型的消息中间件，具有以下特点： 能够保证严格的消息顺序 提供丰富的消息拉取模式 高效的订阅者水平扩展能力 实时的消息订阅机制 亿级消息堆积能力</p>
<h2 id="RocketMQ包含的组件"><a href="#RocketMQ包含的组件" class="headerlink" title="RocketMQ包含的组件"></a>RocketMQ包含的组件</h2><p>NameServer：单点，供Producer和Consumer获取Broker地址<br>Producer：产生并发送消息<br>Consumer：接受并消费消息<br>Broker：消息暂存，消息转发</p>
<h3 id="Name-Server"><a href="#Name-Server" class="headerlink" title="Name Server"></a>Name Server</h3><p>Name Server是RocketMQ的寻址服务。用于把Broker的路由信息做聚合。客户端依靠Name Server决定去获取对应topic的路由信息，从而决定对哪些Broker做连接。<br>Name Server是一个几乎无状态的结点，Name Server之间采取share-nothing的设计，互不通信。<br>对于一个Name Server集群列表，客户端连接Name Server的时候，只会选择随机连接一个结点，以做到负载均衡。<br>Name Server所有状态都从Broker上报而来，本身不存储任何状态，所有数据均在内存。<br>如果中途所有Name Server全都挂了，影响到路由信息的更新，不会影响和Broker的通信。</p>
<h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h3><p>Broker是处理消息存储，转发等处理的服务器。<br>Broker以group分开，每个group只允许一个master，若干个slave。<br>只有master才能进行写入操作，slave不允许。<br>slave从master中同步数据。同步策略取决于master的配置，可以采用同步双写，异步复制两种。<br>客户端消费可以从master和slave消费。在默认情况下，消费者都从master消费，在master挂后，客户端由于从Name Server中感知到Broker挂机，就会从slave消费。<br>Broker向所有的NameServer结点建立长连接，注册Topic信息。</p>
<h2 id="RocketMQ优点"><a href="#RocketMQ优点" class="headerlink" title="RocketMQ优点"></a>RocketMQ优点</h2><p>1.强调集群无单点，可扩展<br>2.任意一点高可用，水平可扩展<br>3.海量消息堆积能力，消息堆积后，写入低延迟。<br>4.支持上万个队列<br>5.消息失败重试机制<br>6.消息可查询<br>7.开源社区活跃<br>8.成熟度（经过双十一考验）</p>
<h2 id="RocketMQ环境安装"><a href="#RocketMQ环境安装" class="headerlink" title="RocketMQ环境安装"></a>RocketMQ环境安装</h2><h3 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h3><p>192.168.110.187 nameServer1,brokerServer1<br>192.168.110.188 nameServer2,brokerServer2</p>
<h3 id="添加Host文件"><a href="#添加Host文件" class="headerlink" title="添加Host文件"></a>添加Host文件</h3><p>vi /etc/hosts</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.110.187 rocketmq-nameserver1</span><br><span class="line">192.168.110.187 rocketmq-master1</span><br><span class="line">192.168.110.188 rocketmq-nameserver2</span><br><span class="line">192.168.110.188 rocketmq-master2</span><br></pre></td></tr></table></figure>

<p>service network restart<br>注意: Error:No suitable device found: no device found for connection “System eth0”<br>解决办法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(1)ifconfig -a 查看物理 MAC HWADDR 的值</span><br><span class="line">(2)vim 编辑文件 &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0中修改ifconfig中查出的MAC HWADDR值；</span><br></pre></td></tr></table></figure>
<h3 id="上传安装包"><a href="#上传安装包" class="headerlink" title="上传安装包"></a>上传安装包</h3><p># 上传alibaba-rocketmq-3.2.6.tar.gz文件至/usr/local<br># tar -zxvf alibaba-rocketmq-3.2.6.tar.gz -C /usr/local<br># mv alibaba-rocketmq alibaba-rocketmq-3.2.6<br># ln -s alibaba-rocketmq-3.2.6 rocketmq</p>
<h3 id="创建存储路径【两台机器】"><a href="#创建存储路径【两台机器】" class="headerlink" title="创建存储路径【两台机器】"></a>创建存储路径【两台机器】</h3><p>mkdir /usr/local/rocketmq/store<br># mkdir /usr/local/rocketmq/store/commitlog<br># mkdir /usr/local/rocketmq/store/consumequeue<br># mkdir /usr/local/rocketmq/store/index</p>
<h3 id="RocketMQ配置文件【两台机器】"><a href="#RocketMQ配置文件【两台机器】" class="headerlink" title="RocketMQ配置文件【两台机器】"></a>RocketMQ配置文件【两台机器】</h3><p># vim /usr/local/rocketmq/conf/2m-noslave/broker-a.properties<br># vim /usr/local/rocketmq/conf/2m-noslave/broker-b.properties</p>
<h3 id="修改日志配置文件【两台机器】"><a href="#修改日志配置文件【两台机器】" class="headerlink" title="修改日志配置文件【两台机器】"></a>修改日志配置文件【两台机器】</h3><p># mkdir -p /usr/local/rocketmq/logs<br># cd /usr/local/rocketmq/conf &amp;&amp; sed -i ‘s#${user.home}#/usr/local/rocketmq#g’ *.xml</p>
<h3 id="修改启动NameServer【两台机器】"><a href="#修改启动NameServer【两台机器】" class="headerlink" title="修改启动NameServer【两台机器】"></a>修改启动NameServer【两台机器】</h3><p>vim /usr/local/rocketmq/bin/runbroker.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPT&#x3D;&quot;$&#123;JAVA_OPT&#125; -server -Xms1g -Xmx1g -Xmn512m -</span><br><span class="line">XX:PermSize&#x3D;128m -XX:MaxPermSize&#x3D;320m&quot;</span><br></pre></td></tr></table></figure>
<p>vim /usr/local/rocketmq/bin/runserver.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPT&#x3D;&quot;$&#123;JAVA_OPT&#125; -server -Xms1g -Xmx1g -Xmn512m -</span><br><span class="line">XX:PermSize&#x3D;128m -XX:MaxPermSize&#x3D;320m&quot;</span><br></pre></td></tr></table></figure>
<h2 id="启动NameServer【两台机器】"><a href="#启动NameServer【两台机器】" class="headerlink" title="启动NameServer【两台机器】"></a>启动NameServer【两台机器】</h2><p># cd /usr/local/rocketmq/bin<br># nohup sh mqnamesrv &amp;</p>
<h2 id="启动BrokerServer-A"><a href="#启动BrokerServer-A" class="headerlink" title="启动BrokerServer A"></a>启动BrokerServer A</h2><p>cd /usr/local/rocketmq/bin<br> # nohup sh mqbroker -c /usr/local/rocketmq/conf/2m-noslave/broker-a.properties &gt;/dev/null 2&gt;&amp;1 &amp;<br> # netstat -ntlp<br> # jps<br> # tail -f -n 500 /usr/local/rocketmq/logs/rocketmqlogs/broker.log<br> # tail -f -n 500 /usr/local/rocketmq/logs/rocketmqlogs/namesrv.log</p>
<h2 id="启动BrokerServer-B"><a href="#启动BrokerServer-B" class="headerlink" title="启动BrokerServer B"></a>启动BrokerServer B</h2><p>cd /usr/local/rocketmq/bin<br> # nohup sh mqbroker -c /usr/local/rocketmq/conf/2m-noslave/broker-b.properties &gt;/dev/null 2&gt;&amp;1 &amp;<br> # netstat -ntlp<br> # jps<br> # tail -f -n 500 /usr/local/rocketmq/logs/rocketmqlogs/broker.log<br> # tail -f -n 500 /usr/local/rocketmq/logs/rocketmqlogs/namesrv.log</p>
<h3 id="RocketMQ-Console"><a href="#RocketMQ-Console" class="headerlink" title="RocketMQ Console"></a>RocketMQ Console</h3><p>将rocketmq-web-console 部署到webapps目录中。<br>/usr/local/apache-tomcat-7.0.65/webapps/rocketmq-web-console/WEB-INF/classes/<br>修改config.properties<br>rocketmq.namesrv.addr=192.168.110.195:9876;192.168.110.199:9876</p>
<h3 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h3><h3 id="安装jdk环境"><a href="#安装jdk环境" class="headerlink" title="安装jdk环境"></a>安装jdk环境</h3><p>vi /etc/profile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;jdk1.7.0_80</span><br><span class="line">export CLASSPATH&#x3D;.:$JAVA_HOME&#x2F;lib&#x2F;dt.jar:$JAVA_HOME&#x2F;lib&#x2F;tools.jar</span><br><span class="line">export PATH&#x3D;$JAVA_HOME&#x2F;bin:$PATH</span><br></pre></td></tr></table></figure>
<p>source /etc/profile</p>
<h1 id="Java操作RocketMQ"><a href="#Java操作RocketMQ" class="headerlink" title="Java操作RocketMQ"></a>Java操作RocketMQ</h1><h2 id="Pom文件依赖"><a href="#Pom文件依赖" class="headerlink" title="Pom文件依赖"></a>Pom文件依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">		DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"rmq-group"</span>);</span><br><span class="line">		producer.setNamesrvAddr(<span class="string">"192.168.110.195:9876;192.168.110.199:9876"</span>);</span><br><span class="line">		producer.setInstanceName(<span class="string">"producer"</span>);</span><br><span class="line">		producer.start();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">				Thread.sleep(<span class="number">1000</span>); <span class="comment">// 每秒发送一次MQ</span></span><br><span class="line">				Message msg = <span class="keyword">new</span> Message(<span class="string">"itmayiedu-topic"</span>, <span class="comment">// topic 主题名称</span></span><br><span class="line">						<span class="string">"TagA"</span>, <span class="comment">// tag 临时值</span></span><br><span class="line">						(<span class="string">"itmayiedu-"</span>+i).getBytes()<span class="comment">// body 内容</span></span><br><span class="line">				);</span><br><span class="line">				SendResult sendResult = producer.send(msg);</span><br><span class="line">				System.out.println(sendResult.toString());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		producer.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">		DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"rmq-group"</span>);</span><br><span class="line"></span><br><span class="line">		consumer.setNamesrvAddr(<span class="string">"192.168.110.195:9876;192.168.110.199:9876"</span>);</span><br><span class="line">		consumer.setInstanceName(<span class="string">"consumer"</span>);</span><br><span class="line">		consumer.subscribe(<span class="string">"itmayiedu-topic"</span>, <span class="string">"TagA"</span>);</span><br><span class="line"></span><br><span class="line">		consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">					System.out.println(msg.getMsgId()+<span class="string">"---"</span>+<span class="keyword">new</span> String(msg.getBody()));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		consumer.start();</span><br><span class="line">		System.out.println(<span class="string">"Consumer Started."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="RocketMQ重试机制"><a href="#RocketMQ重试机制" class="headerlink" title="RocketMQ重试机制"></a>RocketMQ重试机制</h1><p>MQ 消费者的消费逻辑失败时，可以通过设置返回状态达到消息重试的结果。<br>MQ 消息重试只针对集群消费方式生效；广播方式不提供失败重试特性，即消费失败后，失败消息不再重试，继续消费新的消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">		DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"rmq-group"</span>);</span><br><span class="line"></span><br><span class="line">		consumer.setNamesrvAddr(<span class="string">"192.168.110.195:9876;192.168.110.199:9876"</span>);</span><br><span class="line">		consumer.setInstanceName(<span class="string">"consumer"</span>);</span><br><span class="line">		consumer.subscribe(<span class="string">"itmayiedu-topic"</span>, <span class="string">"TagA"</span>);</span><br><span class="line"></span><br><span class="line">		consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">					System.out.println(msg.getMsgId() + <span class="string">"---"</span> + <span class="keyword">new</span> String(msg.getBody()));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">                                <span class="comment">// 需要重试</span></span><br><span class="line">					<span class="keyword">return</span> ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line"></span><br><span class="line">				&#125;</span><br><span class="line">                         <span class="comment">// 不需要重试</span></span><br><span class="line">				<span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		consumer.start();</span><br><span class="line">		System.out.println(<span class="string">"Consumer Started."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="RocketMQ如何解决消息幂等"><a href="#RocketMQ如何解决消息幂等" class="headerlink" title="RocketMQ如何解决消息幂等"></a>RocketMQ如何解决消息幂等</h2><p>注意:每次重试后，消息ID都不一致，所以不能使用消息ID判断幂等。<br>解决办法:使用自定义全局ID判断幂等，例如流水ID、订单号<br>使用msg.setKeys 进行区分</p>
<h3 id="生产者-1"><a href="#生产者-1" class="headerlink" title="生产者:"></a>生产者:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">		DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"rmq-group"</span>);</span><br><span class="line">		producer.setNamesrvAddr(<span class="string">"192.168.110.195:9876;192.168.110.199:9876"</span>);</span><br><span class="line">		producer.setInstanceName(<span class="string">"producer"</span>);</span><br><span class="line">		producer.start();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span>; i++) &#123;</span><br><span class="line">				Thread.sleep(<span class="number">1000</span>); <span class="comment">// 每秒发送一次MQ</span></span><br><span class="line">				Message msg = <span class="keyword">new</span> Message(<span class="string">"itmayiedu-topic"</span>, <span class="comment">// topic 主题名称</span></span><br><span class="line">						<span class="string">"TagA"</span>, <span class="comment">// tag 临时值</span></span><br><span class="line">						(<span class="string">"itmayiedu-6"</span> + i).getBytes()<span class="comment">// body 内容</span></span><br><span class="line">				);</span><br><span class="line">				msg.setKeys(System.currentTimeMillis() + <span class="string">""</span>);</span><br><span class="line">				SendResult sendResult = producer.send(msg);</span><br><span class="line">				System.out.println(sendResult.toString());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		producer.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消费者-1"><a href="#消费者-1" class="headerlink" title="消费者:"></a>消费者:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">private</span> Map&lt;String, String&gt; logMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">	DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"rmq-group"</span>);</span><br><span class="line"></span><br><span class="line">	consumer.setNamesrvAddr(<span class="string">"192.168.110.195:9876;192.168.110.199:9876"</span>);</span><br><span class="line">	consumer.setInstanceName(<span class="string">"consumer"</span>);</span><br><span class="line">	consumer.subscribe(<span class="string">"itmayiedu-topic"</span>, <span class="string">"TagA"</span>);</span><br><span class="line"></span><br><span class="line">	consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">			String key = <span class="keyword">null</span>;</span><br><span class="line">			String msgId = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">					key = msg.getKeys();</span><br><span class="line">					<span class="keyword">if</span> (logMap.containsKey(key)) &#123;</span><br><span class="line">						<span class="comment">// 无需继续重试。</span></span><br><span class="line">						System.out.println(<span class="string">"key:"</span>+key+<span class="string">",无需重试..."</span>);</span><br><span class="line">						<span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">					&#125;</span><br><span class="line">					msgId = msg.getMsgId();</span><br><span class="line">					System.out.println(<span class="string">"key:"</span> + key + <span class="string">",msgid:"</span> + msgId + <span class="string">"---"</span> + <span class="keyword">new</span> String(msg.getBody()));</span><br><span class="line">					<span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">				<span class="keyword">return</span> ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">			&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">				logMap.put(key, msgId);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	consumer.start();</span><br><span class="line">	System.out.println(<span class="string">"Consumer Started."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a href="https://help.aliyun.com/document_detail/44397.html?spm=a2c4g.11186623.6.577.sPsbuu" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/44397.html?spm=a2c4g.11186623.6.577.sPsbuu</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/14/zookeeper%E7%AE%80%E4%BB%8B%20+%20%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/14/zookeeper%E7%AE%80%E4%BB%8B%20+%20%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">zookeeper简介 + 分布式锁实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-14 20:40:12" itemprop="dateCreated datePublished" datetime="2020-04-14T20:40:12+08:00">2020-04-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="zookeeper简介-分布式锁实现"><a href="#zookeeper简介-分布式锁实现" class="headerlink" title="zookeeper简介 + 分布式锁实现"></a>zookeeper简介 + 分布式锁实现</h1><h2 id="什么是-Zookeeper"><a href="#什么是-Zookeeper" class="headerlink" title="什么是 Zookeeper"></a>什么是 Zookeeper</h2><p>Zookeeper是一个分布式开源框架，提供了协调分布式应用的基本服务，它向外部应用暴露一组通用服务——分布式同步（Distributed Synchronization）、命名服务（Naming Service）、集群维护（Group Maintenance）等，简化分布式应用协调及其管理的难度，提供高性能的分布式服务。ZooKeeper本身可以以单机模式安装运行，不过它的长处在于通过分布式ZooKeeper集群（一个Leader，多个Follower），基于一定的策略来保证ZooKeeper集群的稳定性和可用性，从而实现分布式应用的可靠性。</p>
<ol>
<li><p>zookeeper是为别的分布式程序服务的</p>
</li>
<li><p>Zookeeper本身就是一个分布式程序（只要有半数以上节点存活，zk就能正常服务）</p>
</li>
<li><p>Zookeeper所提供的服务涵盖：主从协调、服务器节点动态上下线、统一配置管理、分布式共享锁、统&gt; 一名称服务等</p>
</li>
<li><p>虽然说可以提供各种服务，但是zookeeper在底层其实只提供了两个功能：</p>
</li>
<li><p>管理(存储，读取)用户程序提交的数据（类似namenode中存放的metadata）；  并为用户程序提供数据节点监听服务；</p>
</li>
</ol>
<h2 id="Zookeeper集群机制"><a href="#Zookeeper集群机制" class="headerlink" title="Zookeeper集群机制"></a>Zookeeper集群机制</h2><p>Zookeeper集群的角色：Leader 和 follower<br>只要集群中有半数以上节点存活，集群就能提供服务</p>
<h2 id="Zookeeper特性"><a href="#Zookeeper特性" class="headerlink" title="Zookeeper特性"></a>Zookeeper特性</h2><ol>
<li><p>Zookeeper：一个leader，多个follower组成的集群</p>
</li>
<li><p>全局数据一致：每个server保存一份相同的数据副本，client无论连接到哪个server，数据都是一致的</p>
</li>
<li><p>分布式读写，更新请求转发，由leader实施</p>
</li>
<li><p>更新请求顺序进行，来自同一个client的更新请求按其发送顺序依次执行</p>
</li>
<li><p>数据更新原子性，一次数据更新要么成功，要么失败</p>
</li>
<li><p>实时性，在一定时间范围内，client能读到最新数据</p>
</li>
</ol>
<h2 id="Zookeeper数据结构"><a href="#Zookeeper数据结构" class="headerlink" title="Zookeeper数据结构"></a>Zookeeper数据结构</h2><ol>
<li><p>层次化的目录结构，命名符合常规文件系统规范(类似文件系统）   </p>
</li>
<li><p>每个节点在zookeeper中叫做znode,并且其有一个唯一的路径标识 </p>
</li>
<li><p>节点Znode可以包含数据和子节点（但是EPHEMERAL类型的节点不能有子节点）</p>
</li>
<li><p>节点类型  </p>
<p>   （1） Znode有两种<strong>类型</strong>：</p>
<p>   <strong>短暂</strong>（ephemeral）（create -e /app1/test1 “test1” 客户端断开连接zk删除ephemeral类型节点）<br>   <strong>持久</strong>（persistent） （create -s /app1/test2 “test2” 客户端断开连接zk不删除persistent类型节点）</p>
<p>   （2）Znode有四种形式的<strong>目录节点</strong>（默认是persistent ）</p>
<p>   <strong>PERSISTENT</strong>  persistent （持久的）<br>   <strong>PERSISTENT_SEQUENTIAL</strong>（持久序列/test0000000019 ）<br>   <strong>EPHEMERAL</strong>  ephemeral（短暂的）<br>   <strong>EPHEMERAL_SEQUENTIAL</strong>（短暂的顺序）</p>
<p>   （3）创建znode时设置顺序标识，znode名称后会附加一个值，顺序号是一个单调递增的计数器，由父节点维护  </p>
<p>   （4）在分布式系统中，顺序号可以被用于为所有的事件进行全局排序，这样客户端可以通过顺序号推断事件的顺序  </p>
</li>
</ol>
<h2 id="Zookeeper应用场景"><a href="#Zookeeper应用场景" class="headerlink" title="Zookeeper应用场景"></a>Zookeeper应用场景</h2><h3 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a><strong>配置中心</strong></h3><p>发布与订阅模型，即所谓的配置中心，顾名思义就是发布者将数据发布到ZK节点上，供订阅者动态获取数据，实现配置信息的集中式管理和动态更新。例如全局的配置信息，服务式服务框架的服务地址列表等就非常适合使用。</p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a><strong>负载均衡</strong></h3><p>这里说的负载均衡是指软负载均衡。在分布式环境中，为了保证高可用性，通常同一个应用或同一个服务的提供方都会部署多份，达到对等服务。而消费者就须要在这些对等的服务器中选择一个来执行相关的业务逻辑，其中比较典型的是消息中间件中的生产者，消费者负载均衡。</p>
<p>消息中间件中发布者和订阅者的负载均衡，linkedin开源的KafkaMQ和阿里开源的 metaq都是通过zookeeper来做到生产者、消费者的负载均衡。这里以metaq为例如讲下：</p>
<p>生产者负载均衡：metaq发送消息的时候，生产者在发送消息的时候必须选择一台broker上的一个分区来发送消息，因此metaq在运行过程中，会把所有broker和对应的分区信息全部注册到ZK指定节点上，默认的策略是一个依次轮询的过程，生产者在通过ZK获取分区列表之后，会按照brokerId和partition的顺序排列组织成一个有序的分区列表，发送的时候按照从头到尾循环往复的方式选择一个分区来发送消息。</p>
<p>消费负载均衡： 在消费过程中，一个消费者会消费一个或多个分区中的消息，但是一个分区只会由一个消费者来消费。MetaQ的消费策略是：</p>
<ol>
<li><p>每个分区针对同一个group只挂载一个消费者。</p>
</li>
<li><p>如果同一个group的消费者数目大于分区数目，则多出来的消费者将不参与消费。</p>
</li>
<li><p>如果同一个group的消费者数目小于分区数目，则有部分消费者需要额外承担消费任务。</p>
</li>
</ol>
<p>在某个消费者故障或者重启等情况下，其他消费者会感知到这一变化（通过 zookeeper watch消费者列表），然后重新进行负载均衡，保证所有的分区都有消费者进行消费。</p>
<h3 id="命名服务-Naming-Service"><a href="#命名服务-Naming-Service" class="headerlink" title="命名服务 (Naming Service)"></a><strong>命名服务</strong> <strong>(Naming Service)</strong></h3><p>命名服务也是分布式系统中比较常见的一类场景。在分布式系统中，通过使用命名服务，客户端应用能够根据指定名字来获取资源或服务的地址，提供者等信息。被命名的实体通常可以是集群中的机器，提供的服务地址，远程对象等等——这些我们都可以统称他们为名字（Name）。其中较为常见的就是一些分布式服务框架中的服务地址列表。通过调用ZK提供的创建节点的API，能够很容易创建一个全局唯一的path，这个path就可以作为一个名称。</p>
<p>阿里巴巴集团开源的分布式服务框架Dubbo中使用ZooKeeper来作为其命名服务，维护全局的服务地址列表， 点击这里查看Dubbo开源项目。在Dubbo实现中：</p>
<p>服务提供者在启动的时候，向ZK上的指定节点/dubbo/${serviceName}/providers目录下写入自己的URL地址，这个操作就完成了服务的发布。</p>
<p>服务消费者启动的时候，订阅/dubbo/${serviceName}/providers目录下的提供者URL地址， 并向/dubbo/${serviceName} /consumers目录下写入自己的URL地址。</p>
<p>注意，所有向ZK上注册的地址都是临时节点，这样就能够保证服务提供者和消费者能够自动感应资源的变化。 另外，Dubbo还有针对服务粒度的监控，方法是订阅/dubbo/${serviceName}目录下所有提供者和消费者的信息。</p>
<h3 id="分布式通知-协调"><a href="#分布式通知-协调" class="headerlink" title="分布式通知 / 协调"></a><strong>分布式通知</strong> <strong>/</strong> <strong>协调</strong></h3><p>ZooKeeper中特有watcher注册与异步通知机制，能够很好的实现分布式环境下不同系统之间的通知与协调，实现对数据变更的实时处理。使用方法通常是不同系统都对ZK上同一个znode进行注册，监听znode的变化（包括znode本身内容及子节点的），其中一个系统update了znode，那么另一个系统能够收到通知，并作出相应处理</p>
<ol>
<li><p>另一种心跳检测机制：检测系统和被检测系统之间并不直接关联起来，而是通过zk上某个节点关联，大大减少系统耦合。</p>
</li>
<li><p>另一种系统调度模式：某系统有控制台和推送系统两部分组成，控制台的职责是控制推送系统进行相应的推送工作。管理人员在控制台作的一些操作，实际上是修改了ZK上某些节点的状态，而ZK就把这些变化通知给他们注册Watcher的客户端，即推送系统，于是，作出相应的推送任务。</p>
</li>
<li><p>另一种工作汇报模式：一些类似于任务分发系统，子任务启动后，到zk来注册一个临时节点，并且定时将自己的进度进行汇报（将进度写回这个临时节点），这样任务管理者就能够实时知道任务进度。</p>
</li>
</ol>
<p>总之，使用zookeeper来进行分布式通知和协调能够大大降低系统之间的耦合</p>
<h3 id="集群管理与-Master-选举"><a href="#集群管理与-Master-选举" class="headerlink" title="集群管理与 Master 选举"></a><strong>集群管理与</strong> <strong>Master</strong> <strong>选举</strong></h3><h4 id="集群机器监控："><a href="#集群机器监控：" class="headerlink" title="集群机器监控："></a><strong>集群机器监控</strong>：</h4><p>这通常用于那种对集群中机器状态，机器在线率有较高要求的场景，能够快速对集群中机器变化作出响应。这样的场景中，往往有一个监控系统，实时检测集群机器是否存活。过去的做法通常是：监控系统通过某种手段（比如ping）定时检测每个机器，或者每个机器自己定时向监控系统汇报“我还活着”。   </p>
<p>这种做法可行，但是存在两个比较明显的<strong>问题</strong>：</p>
<ol>
<li>集群中机器有变动的时候，牵连修改的东西比较多。</li>
<li>有一定的延时。</li>
</ol>
<p>利用ZooKeeper有两个特性，就可以实现另一种集群机器存活性监控系统：</p>
<ol>
<li><p>客户端在节点 x 上注册一个Watcher，那么如果 x?的子节点变化了，会通知该客户端。</p>
</li>
<li><p>创建<strong>EPHEMERAL</strong>类型的节点，一旦客户端和服务器的会话结束或过期，那么该节点就会消失。</p>
</li>
<li><p>例如，监控系统在 /clusterServers 节点上注册一个Watcher，以后每动态加机器，那么就往 /clusterServers 下创建一个 EPHEMERAL类型的节点：/clusterServers/{hostname}. 这样，监控系统就能够实时知道机器的增减情况，至于后续处理就是监控系统的业务了。</p>
</li>
</ol>
<h4 id="Master选举"><a href="#Master选举" class="headerlink" title="Master选举"></a><strong>Master选举</strong></h4><p>在分布式环境中，相同的业务应用分布在不同的机器上，有些业务逻辑（例如一些耗时的计算，网络I/O处理），往往只需要让整个集群中的某一台机器进行执行，其余机器可以共享这个结果，这样可以大大减少重复劳动，提高性能，于是这个master选举便是这种场景下的碰到的主要问题。</p>
<p>利用ZooKeeper的强一致性，能够保证在分布式高并发情况下节点创建的全局唯一性，即：<strong>同时有多个客户端请求创建 /currentMaster 节点，最终一定只有一个客户端请求能够创建成功</strong>。利用这个特性，就能很轻易的在分布式环境中进行集群选取了。另外，这种场景演化一下，就是动态Master选举。这就要用到 <strong>EPHEMERAL_SEQUENTIAL</strong> 类型节点的特性了。</p>
<p>上文中提到，所有客户端创建请求，最终只有一个能够创建成功。在这里稍微变化下，就是允许所有请求都能够创建成功，但是得有个创建顺序，于是所有的请求最终在ZK上创建结果的一种可能情况是这样：/currentMaster/{sessionId}-1 ,/currentMaster/{sessionId}-2,/currentMaster/{sessionId}-3 ….  每次选取序列号最小的那个机器作为Master，如果这个机器挂了，由于他创建的节点会马上<strong>消失</strong>，那么之后最小的那个机器就是Master了。</p>
<p>在搜索系统中，如果集群中每个机器都生成一份全量索引，不仅耗时，而且不能保证彼此之间索引数据一致。因此让集群中的Master来进行全量索引的生成，然后同步到集群中其它机器。另外，Master选举的容灾措施是，可以随时进行手动指定master，就是说应用在zk在无法获取master信息时，可以通过比如http方式，向一个地方获取master。</p>
<p> 在Hbase中，也是使用ZooKeeper来实现动态HMaster的选举。在Hbase实现中，会在ZK上存储一些ROOT表的地址和HMaster的地址，HRegionServer也会把自己以临时节点（Ephemeral）的方式注册到Zookeeper中，使得HMaster可以随时感知到各个HRegionServer的存活状态，同时，一旦HMaster出现问题，会重新选举出一个HMaster来运行，从而避免了HMaster的单点问题</p>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a><strong>分布式锁</strong></h3><p>分布式锁，这个主要得益于 ZooKeeper 为我们保证了数据的强一致性。锁服务可以分为两类，一个是 保持独占，另一个是 控制时序。</p>
<ol>
<li><p>所谓保持独占，就是所有试图来获取这个锁的客户端，最终只有一个可以成功获得这把锁。通常的做法是把 zk 上的一个 znode 看作是一把锁，通过 create znode 的方式来实现。所有客户端都去创建 /distribute_lock 节点，最终成功创建的那个客户端也即拥有了这把锁。</p>
</li>
<li><p>控制时序，就是所有视图来获取这个锁的客户端，最终都是会被安排执行，只是有个全局时序了。做法和上面基本类似，只是这里 /distributelock 已经预先存在，客户端在它下面创建临时有序节点（这个可以通过节点的属性控制：CreateMode.EPHEMERALSEQUENTIAL 来指定）。Zk 的父节点（/distribute_lock）维持一份 sequence, 保证子节点创建的时序性，从而也形成了每个客户端的全局时序。</p>
</li>
</ol>
<h2 id="Zookeeper-windows环境安装"><a href="#Zookeeper-windows环境安装" class="headerlink" title="Zookeeper windows环境安装"></a>Zookeeper windows环境安装</h2><p>环境要求:必须要有jdk环境</p>
<p>1.安装jdk</p>
<p>2.安装Zookeeper. 在官网<a href="http://zookeeper.apache.org/下载zookeeper.我下载的是zookeeper-3.4.6版本。" target="_blank" rel="noopener">http://zookeeper.apache.org/下载zookeeper.我下载的是zookeeper-3.4.6版本。</a></p>
<p>解压zookeeper-3.4.6至D:\machine\zookeeper-3.4.6.</p>
<p>在D:\machine 新建data及log目录。</p>
<ol start="3">
<li>ZooKeeper的安装模式分为三种，分别为：单机模式（stand-alone）、集群模式和集群伪分布模式。ZooKeeper 单机模式的安装相对比较简单，如果第一次接触ZooKeeper的话，建议安装ZooKeeper单机模式或者集群伪分布模式。</li>
</ol>
<p>安装单击模式。 至D:\machine\zookeeper-3.4.6\conf 复制 zoo_sample.cfg 并粘贴到当前目录下，命名zoo.cfg.</p>
<h2 id="Zookeeper集群环境搭建-linux"><a href="#Zookeeper集群环境搭建-linux" class="headerlink" title="Zookeeper集群环境搭建(linux)"></a>Zookeeper集群环境搭建(linux)</h2><p>环境要求:必须要有jdk环境</p>
<h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>一共三个节点<br> (zk服务器集群规模不小于3个节点),要求服务器之间系统时间保持一致。</p>
<h3 id="上传zk并且解压"><a href="#上传zk并且解压" class="headerlink" title="上传zk并且解压"></a>上传zk并且解压</h3><p>进行解压： tar -zxvf zookeeper-3.4.6.tar.gz </p>
<p> 重命名： mv zookeeper-3.4.6 zookeeper</p>
<h3 id="修改zookeeper环境变量"><a href="#修改zookeeper环境变量" class="headerlink" title="修改zookeeper环境变量"></a>修改zookeeper环境变量</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">/etc/profile</span></span><br><span class="line"><span class="string">export</span> <span class="string">JAVA_HOME=/opt/jdk1.8.0_71</span></span><br><span class="line"><span class="string">export</span> <span class="string">ZOOKEEPER_HOME=/usr/local/zookeeper</span></span><br><span class="line"><span class="string">export</span> <span class="string">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span></span><br><span class="line"><span class="string">export</span> <span class="string">PATH=$JAVA_HOME/bin:$ZOOKEEPER_HOME/bin:$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="string">source</span> <span class="string">/etc/profile</span></span><br></pre></td></tr></table></figure>

<h3 id="修改zoo-sample-cfg文件"><a href="#修改zoo-sample-cfg文件" class="headerlink" title="修改zoo_sample.cfg文件"></a>修改zoo_sample.cfg文件</h3><p> cd /usr/local/zookeeper/conf  </p>
<p>mv zoo_sample.cfg zoo.cfg  </p>
<p>修改conf: vi zoo.cfg 修改两处  </p>
<p>（1） dataDir=/usr/local/zookeeper/data（注意同时在zookeeper创建data目录）  </p>
<p>（2）最后面添加 </p>
<p>server.0=bhz:2888:3888  </p>
<p>server.1=hadoop1:2888:3888  </p>
<p>server.2=hadoop2:2888:3888</p>
<h3 id="创建服务器标识"><a href="#创建服务器标识" class="headerlink" title="创建服务器标识"></a>创建服务器标识</h3><p>服务器标识配置：  </p>
<p>创建文件夹： mkdir data  </p>
<p>创建文件myid并填写内容为0：</p>
<p> vi  myid (内容为服务器标识 ： 0)</p>
<h3 id="复制zookeeper"><a href="#复制zookeeper" class="headerlink" title="复制zookeeper"></a>复制zookeeper</h3><p>进行复制zookeeper目录到hadoop01和hadoop02<br>还有/etc/profile文件<br>把hadoop01、 hadoop02中的myid文件里的值修改为1和2<br>路径(vi /usr/local/zookeeper/data/myid)</p>
<h3 id="启动zookeeper"><a href="#启动zookeeper" class="headerlink" title="启动zookeeper"></a>启动zookeeper</h3><p>启动zookeeper：  </p>
<p>路径： /usr/local/zookeeper/bin  </p>
<p>执行： zkServer.sh start  (注意这里3台机器都要进行启动)  </p>
<p>状态： zkServer.sh   status(在三个节点上检验zk的mode,一个leader和俩个follower)</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>zkServer.sh status 查询状态</p>
<h2 id="Zookeeper配置文件介绍"><a href="#Zookeeper配置文件介绍" class="headerlink" title="Zookeeper配置文件介绍"></a>Zookeeper配置文件介绍</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The number of milliseconds of each tick </span></span><br><span class="line"><span class="comment"># 心跳时间，为了确保连接存在的，以毫秒为单位，最小超时时间为两个心跳时间</span></span><br><span class="line"></span><br><span class="line"><span class="string">tickTime=2000</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># The number of ticks that the initial  </span></span><br><span class="line"><span class="comment"># synchronization phase can take </span></span><br><span class="line"><span class="comment"># 多少个心跳时间内，允许其他server连接并初始化数据，</span></span><br><span class="line"><span class="comment"># 如果ZooKeeper管理的数据较大，则应相应增大这个值</span></span><br><span class="line"></span><br><span class="line"><span class="string">initLimit=10</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># The number of ticks that can pass between  </span></span><br><span class="line"><span class="comment"># sending a request and getting an acknowledgement </span></span><br><span class="line"><span class="comment"># 多少个tickTime内，允许follower同步，如果follower落后太多，则会被丢弃。</span></span><br><span class="line"><span class="string">syncLimit=5</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># the directory where the snapshot is stored. </span></span><br><span class="line"><span class="comment"># do not use /tmp for storage, /tmp here is just  </span></span><br><span class="line"><span class="comment"># example sakes. </span></span><br><span class="line"><span class="comment"># 用于存放内存数据库快照的文件夹，同时用于集群的myid文件也存在这个文件夹里</span></span><br><span class="line"><span class="comment"># （注意：一个配置文件只能包含一个dataDir字样，即使它被注释掉了。）</span></span><br><span class="line"><span class="string">dataDir=/home/myuser/zooA/data</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># the port at which the clients will connect </span></span><br><span class="line"><span class="comment"># 服务的监听端口</span></span><br><span class="line"><span class="string">clientPort=2181</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># ZooKeeper server and its port no. # ZooKeeper ensemble should know about every other machine in the ensemble # specify server id by creating 'myid' file in the dataDir # use hostname instead of IP address for convenient maintenance</span></span><br><span class="line"><span class="string">server.A=B：C：D：</span></span><br><span class="line"><span class="string">A是一个数字,表示这个是第几号服务器,B是这个服务器的ip地址</span></span><br><span class="line"><span class="string">C第一个端口用来集群成员的信息交换,表示的是这个服务器与集群中的Leader服务器交换信息的端口</span></span><br><span class="line"><span class="string">D是在leader挂掉时专门用来进行选举leader所用</span></span><br><span class="line"></span><br><span class="line"><span class="string">server.1=127.0.0.1:2888:3888</span> </span><br><span class="line"><span class="string">server.2=127.0.0.1:2988:3988</span>  </span><br><span class="line"><span class="string">server.3=127.0.0.1:2088:3088</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># Be sure to read the maintenance section of the  </span></span><br><span class="line"><span class="comment"># administrator guide before turning on autopurge. </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># The number of snapshots to retain in dataDir </span></span><br><span class="line"><span class="comment"># autopurge.snapRetainCount=3 </span></span><br><span class="line"><span class="comment"># Purge task interval in hours </span></span><br><span class="line"><span class="comment"># Set to "0" to disable auto purge feature  &lt;br&gt;</span></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1 </span></span><br><span class="line"><span class="comment"># 用于单独设置transaction log的目录，</span></span><br><span class="line"><span class="comment"># transaction log分离可以避免和普通log还有快照的竞争</span></span><br><span class="line"><span class="string">dataLogDir=/home/myuser/zooA/log</span></span><br></pre></td></tr></table></figure>

<h2 id="Zookeeper客户端"><a href="#Zookeeper客户端" class="headerlink" title="Zookeeper客户端"></a>Zookeeper客户端</h2><p>ZooKeeper命令行工具类似于Linux的shell环境，不过功能不及shell，但是使用它我们可以简单的对ZooKeeper进行访问，数据创建，数据修改等操作. 使用 zkCli.sh -server 127.0.0.1:2181 连接到 ZooKeeper 服务，连接成功后，系统会输出 ZooKeeper 的相关环境以及配置信息。</p>
<p>命令行工具的一些简单操作如下：</p>
<ol>
<li><p>显示根目录下、文件： ls / 使用 ls 命令来查看当前 ZooKeeper 中所包含的内容</p>
</li>
<li><p>显示根目录下、文件： ls2 / 查看当前节点数据并能看到更新次数等数据</p>
</li>
<li><p>创建文件，并设置初始内容： create /zk “test” 创建一个新的 znode节点“ zk ”以及与它关联的字符串</p>
</li>
<li><p>获取文件内容： get /zk 确认 znode 是否包含我们所创建的字符串</p>
</li>
<li><p>修改文件内容： set /zk “zkbak” 对 zk 所关联的字符串进行设置</p>
</li>
<li><p>删除文件： delete /zk 将刚才创建的 znode 删除</p>
</li>
<li><p>退出客户端： quit</p>
</li>
<li><p>帮助命令： help</p>
</li>
</ol>
<h1 id="Java操作Zookeeper"><a href="#Java操作Zookeeper" class="headerlink" title="Java操作Zookeeper"></a>Java操作Zookeeper</h1><h2 id="Zookeeper说明"><a href="#Zookeeper说明" class="headerlink" title="Zookeeper说明"></a>Zookeeper说明</h2><p>创建节点(znode) 方法: </p>
<p> create:  </p>
<p>提供了两套创建节点的方法，同步和异步创建节点方式。    </p>
<p>同步方式: </p>
<p>参数1，节点路径《名称) : InodeName (不允许递归创建节点，也就是说在父节点不存在  的情况下，不允许创建子节点)  </p>
<p>参数2，节点内容: 要求类型是字节数组(也就是说，不支持序列化方式，如果需要实现序  列化，可使用java相关序列化框架，如Hessian、Kryo框架)  </p>
<p>参数3，节点权限: 使用Ids.OPEN_ACL_UNSAFE开放权限即可。(这个参数一般在权展  没有太高要求的场景下，没必要关注)  </p>
<p>参数4，节点类型: 创建节点的类型: CreateMode，提供四种首点象型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PERSISTENT                  持久化节点</span><br><span class="line">PERSISTENT_SEQUENTIAL       顺序自动编号持久化节点，这种节点会根据当前已存在的节点数自动加1</span><br><span class="line">EPHEMERAL                   临时节点， 客户端session超时这类节点就会被自动删除</span><br><span class="line">EPHEMERAL_SEQUENTIAL        临时自动编号节点</span><br></pre></td></tr></table></figure>

<h2 id="Maven依赖信息"><a href="#Maven依赖信息" class="headerlink" title="Maven依赖信息"></a>Maven依赖信息</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Zookeeper客户端连接"><a href="#Zookeeper客户端连接" class="headerlink" title="Zookeeper客户端连接"></a>Zookeeper客户端连接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test001</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//连接地址</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ADDRES = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line">	<span class="comment">//session 会话</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">2000</span>;</span><br><span class="line">	<span class="comment">//信号量,阻塞程序执行,用户等待zookeeper连接成功,发送成功信号，</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException </span>&#123;</span><br><span class="line">		ZooKeeper zk = <span class="keyword">new</span> ZooKeeper(ADDRES, SESSION_OUTTIME, <span class="keyword">new</span> Watcher() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">				<span class="comment">// 获取事件状态</span></span><br><span class="line">				KeeperState keeperState = event.getState();</span><br><span class="line">				<span class="comment">// 获取事件类型</span></span><br><span class="line">				EventType eventType = event.getType();</span><br><span class="line">				<span class="keyword">if</span> (KeeperState.SyncConnected == keeperState) &#123;</span><br><span class="line">					<span class="keyword">if</span> (EventType.None == eventType) &#123;</span><br><span class="line">						countDownLatch.countDown();</span><br><span class="line">						System.out.println(<span class="string">"zk 启动连接..."</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="comment">// 进行阻塞</span></span><br><span class="line">		countDownLatch.await();</span><br><span class="line">		String result = zk.create(<span class="string">"/itmayeidu_Lasting"</span>, <span class="string">"Lasting"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">				CreateMode.PERSISTENT);</span><br><span class="line">		System.out.println(result);</span><br><span class="line">		zk.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建Zookeeper节点信息"><a href="#创建Zookeeper节点信息" class="headerlink" title="创建Zookeeper节点信息"></a>创建Zookeeper节点信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.	创建持久节点，并且允许任何服务器可以操作</span><br><span class="line">	String result = zk.create(<span class="string">"/itmayiedu_Lasting"</span>, <span class="string">"Lasting"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">	System.out.println(<span class="string">"result:"</span> + result);</span><br><span class="line"><span class="number">2</span>.	创建临时节点</span><br><span class="line">	String result = zk.create(<span class="string">"/itmayiedu_temp"</span>, <span class="string">"temp"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">	System.out.println(<span class="string">"result:"</span> + result);</span><br></pre></td></tr></table></figure>

<h2 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h2><p>在ZooKeeper中，接口类Watcher用于表示一个标准的事件处理器，其定义了事件通知相关的逻辑，包含KeeperState和EventType两个枚举类，分别代表了通知状态和事件类型，同时定义了事件的回调方法：process（WatchedEvent event）。</p>
<h3 id="什么是Watcher接口"><a href="#什么是Watcher接口" class="headerlink" title="什么是Watcher接口"></a>什么是Watcher接口</h3><p>同一个事件类型在不同的通知状态中代表的含义有所不同，表7-3列举了常见的通知状态和事件类型。</p>
<p>表Watcher通知状态与事件类型一览</p>
<table>
<thead>
<tr>
<th>KeeperState</th>
<th>EventType</th>
<th>触发条件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>None   （-1）</td>
<td>客户端与服务端成功建立连接</td>
<td></td>
</tr>
<tr>
<td>SyncConnected   （0）</td>
<td>NodeCreated   （1）</td>
<td>Watcher监听的对应数据节点被创建</td>
<td></td>
</tr>
<tr>
<td></td>
<td>NodeDeleted   （2）</td>
<td>Watcher监听的对应数据节点被删除</td>
<td>此时客户端和服务器处于连接状态</td>
</tr>
<tr>
<td></td>
<td>NodeDataChanged   （3）</td>
<td>Watcher监听的对应数据节点的数据内容发生变更</td>
<td></td>
</tr>
<tr>
<td></td>
<td>NodeChildChanged   （4）</td>
<td>Wather监听的对应数据节点的子节点列表发生变更</td>
<td></td>
</tr>
<tr>
<td>Disconnected   （0）</td>
<td>None   （-1）</td>
<td>客户端与ZooKeeper服务器断开连接</td>
<td>此时客户端和服务器处于断开连接状态</td>
</tr>
<tr>
<td>Expired   （-112）</td>
<td>Node   （-1）</td>
<td>会话超时</td>
<td>此时客户端会话失效，通常同时也会受到SessionExpiredException异常</td>
</tr>
<tr>
<td>AuthFailed   （4）</td>
<td>None   （-1）</td>
<td>通常有两种情况，1：使用错误的schema进行权限检查 2：SASL权限检查失败</td>
<td>通常同时也会收到AuthFailedException异常</td>
</tr>
</tbody></table>
<p>表中列举了ZooKeeper中最常见的几个通知状态和事件类型。</p>
<p><strong>回调方法process（）</strong></p>
<p>process方法是Watcher接口中的一个回调方法，当ZooKeeper向客户端发送一个Watcher事件通知时，客户端就会对相应的process方法进行回调，从而实现对事件的处理。process方法的定义如下：</p>
<p><strong>abstract public void process(WatchedEvent event);</strong></p>
<p>这个回调方法的定义非常简单，我们重点看下方法的参数定义：WatchedEvent。</p>
<p>WatchedEvent包含了每一个事件的三个基本属性：通知状态（keeperState），事件类型（EventType）和节点路径（path）。ZooKeeper使用WatchedEvent对象来封装服务端事件并传递给Watcher，从而方便回调方法process对服务端事件进行处理。</p>
<p>提到WatchedEvent，不得不讲下WatcherEvent实体。笼统地讲，两者表示的是同一个事物，都是对一个服务端事件的封装。不同的是，WatchedEvent是一个逻辑事件，用于服务端和客户端程序执行过程中所需的逻辑对象，而WatcherEvent因为实现了序列化接口，因此可以用于网络传输。</p>
<p>服务端在生成WatchedEvent事件之后，会调用getWrapper方法将自己包装成一个可序列化的WatcherEvent事件，以便通过网络传输到客户端。客户端在接收到服务端的这个事件对象后，首先会将WatcherEvent还原成一个WatchedEvent事件，并传递给process方法处理，回调方法process根据入参就能够解析出完整的服务端事件了。</p>
<p>需要注意的一点是，无论是WatchedEvent还是WatcherEvent，其对ZooKeeper服务端事件的封装都是机及其简单的。举个例子来说，当/zk-book这个节点的数据发生变更时，服务端会发送给客户端一个“ZNode数据内容变更”事件，客户端只能够接收到如下信息</p>
<h3 id="Watcher代码"><a href="#Watcher代码" class="headerlink" title="Watcher代码"></a>Watcher代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZkClientWatcher</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 集群连接地址</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDRES = <span class="string">"192.168.110.159:2181,192.168.110.160:2181,192.168.110.162:2181"</span>;</span><br><span class="line">	<span class="comment">// 会话超时时间</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSIONTIME = <span class="number">2000</span>;</span><br><span class="line">	<span class="comment">// 信号量,让zk在连接之前等待,连接成功后才能往下走.</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String LOG_MAIN = <span class="string">"【main】 "</span>;</span><br><span class="line">	<span class="keyword">private</span> ZooKeeper zk;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createConnection</span><span class="params">(String connectAddres, <span class="keyword">int</span> sessionTimeOut)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			zk = <span class="keyword">new</span> ZooKeeper(connectAddres, sessionTimeOut, <span class="keyword">this</span>);</span><br><span class="line">			System.out.println(LOG_MAIN + <span class="string">"zk 开始启动连接服务器...."</span>);</span><br><span class="line">			countDownLatch.await();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">createPath</span><span class="params">(String path, String data)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.exists(path, <span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">this</span>.zk.create(path, data.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">			System.out.println(LOG_MAIN + <span class="string">"节点创建成功, Path:"</span> + path + <span class="string">",data:"</span> + data);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 判断指定节点是否存在</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">	 *            节点路径</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Stat <span class="title">exists</span><span class="params">(String path, <span class="keyword">boolean</span> needWatch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.zk.exists(path, needWatch);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateNode</span><span class="params">(String path,String data)</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">		exists(path, <span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">this</span>.zk.setData(path, data.getBytes(), -<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取事件状态</span></span><br><span class="line">		KeeperState keeperState = watchedEvent.getState();</span><br><span class="line">		<span class="comment">// 获取事件类型</span></span><br><span class="line">		EventType eventType = watchedEvent.getType();</span><br><span class="line">		<span class="comment">// zk 路径</span></span><br><span class="line">		String path = watchedEvent.getPath();</span><br><span class="line">		System.out.println(<span class="string">"进入到 process() keeperState:"</span> + keeperState + <span class="string">", eventType:"</span> + eventType + <span class="string">", path:"</span> + path);</span><br><span class="line">		<span class="comment">// 判断是否建立连接</span></span><br><span class="line">		<span class="keyword">if</span> (KeeperState.SyncConnected == keeperState) &#123;</span><br><span class="line">			<span class="keyword">if</span> (EventType.None == eventType) &#123;</span><br><span class="line">				<span class="comment">// 如果建立建立成功,让后程序往下走</span></span><br><span class="line">				System.out.println(LOG_MAIN + <span class="string">"zk 建立连接成功!"</span>);</span><br><span class="line">				countDownLatch.countDown();</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeCreated == eventType) &#123;</span><br><span class="line">				System.out.println(LOG_MAIN + <span class="string">"事件通知,新增node节点"</span> + path);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeDataChanged == eventType) &#123;</span><br><span class="line">				System.out.println(LOG_MAIN + <span class="string">"事件通知,当前node节点"</span> + path + <span class="string">"被修改...."</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeDeleted == eventType) &#123;</span><br><span class="line">				System.out.println(LOG_MAIN + <span class="string">"事件通知,当前node节点"</span> + path + <span class="string">"被删除...."</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"--------------------------------------------------------"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">		ZkClientWatcher zkClientWatcher = <span class="keyword">new</span> ZkClientWatcher();</span><br><span class="line">		zkClientWatcher.createConnection(CONNECT_ADDRES, SESSIONTIME);</span><br><span class="line"><span class="comment">//		boolean createResult = zkClientWatcher.createPath("/p15", "pa-644064");</span></span><br><span class="line">		zkClientWatcher.updateNode(<span class="string">"/pa2"</span>,<span class="string">"7894561"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分布式锁实现"><a href="#分布式锁实现" class="headerlink" title="分布式锁实现"></a>分布式锁实现</h1><h2 id="传统方式生成订单号ID"><a href="#传统方式生成订单号ID" class="headerlink" title="传统方式生成订单号ID"></a>传统方式生成订单号ID</h2><h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>在分布式情况，生成全局订单号ID</p>
<h3 id="生成订单号方案"><a href="#生成订单号方案" class="headerlink" title="生成订单号方案"></a>生成订单号方案</h3><ol>
<li>使用时间戳</li>
<li>使用UUID</li>
<li>推特 (Twitter) 的 Snowflake 算法——用于生成唯一 ID</li>
</ol>
<h3 id="生成订单类"><a href="#生成订单类" class="headerlink" title="生成订单类"></a>生成订单类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成订单类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNumGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">//全局订单id</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">200</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		&#125;</span><br><span class="line">		SimpleDateFormat simpt = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd-HH-mm-ss"</span>);</span><br><span class="line">		<span class="keyword">return</span> simpt.format(<span class="keyword">new</span> Date()) + <span class="string">"-"</span> + ++count;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用多线程情况模拟生成订单号"><a href="#使用多线程情况模拟生成订单号" class="headerlink" title="使用多线程情况模拟生成订单号"></a>使用多线程情况模拟生成订单号</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用多线程模拟生成订单号</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> OrderNumGenerator orderNumGenerator = <span class="keyword">new</span> OrderNumGenerator();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		getNumber();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String number = orderNumGenerator.getNumber();</span><br><span class="line">		System.out.println(Thread.currentThread().getName() + <span class="string">",生成订单ID:"</span> + number);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"####生成唯一订单号###"</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">new</span> OrderService()).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多线程生成订单号，线程安全问题解决"><a href="#多线程生成订单号，线程安全问题解决" class="headerlink" title="多线程生成订单号，线程安全问题解决"></a>多线程生成订单号，线程安全问题解决</h3><p>使用synchronized或者loca锁</p>
<h4 id="Synchronized同步代码块方式"><a href="#Synchronized同步代码块方式" class="headerlink" title="Synchronized同步代码块方式"></a>Synchronized同步代码块方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用多线程模拟生成订单号</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> OrderNumGenerator orderNumGenerator = <span class="keyword">new</span> OrderNumGenerator();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		getNumber();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">			String number = orderNumGenerator.getNumber();</span><br><span class="line">			System.out.println(Thread.currentThread().getName() + <span class="string">",生成订单ID:"</span> + number);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"####生成唯一订单号###"</span>);</span><br><span class="line">		OrderService orderService = <span class="keyword">new</span> OrderService();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(orderService).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Lock锁方式"><a href="#Lock锁方式" class="headerlink" title="Lock锁方式"></a>Lock锁方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> OrderNumGenerator orderNumGenerator = <span class="keyword">new</span> OrderNumGenerator();</span><br><span class="line">	<span class="comment">// 使用lock锁</span></span><br><span class="line">	<span class="keyword">private</span> java.util.concurrent.locks.Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		getNumber();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// synchronized (this) &#123;</span></span><br><span class="line">			lock.lock();</span><br><span class="line">			String number = orderNumGenerator.getNumber();</span><br><span class="line">			System.out.println(Thread.currentThread().getName() + <span class="string">",生成订单ID:"</span> + number);</span><br><span class="line">			<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"####生成唯一订单号###"</span>);</span><br><span class="line">		OrderService orderService = <span class="keyword">new</span> OrderService();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(orderService).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分布式场景下生成订单ID"><a href="#分布式场景下生成订单ID" class="headerlink" title="分布式场景下生成订单ID"></a>分布式场景下生成订单ID</h2><h3 id="业务场景-1"><a href="#业务场景-1" class="headerlink" title="业务场景"></a>业务场景</h3><p>在分布式情况，生成全局订单号ID</p>
<h3 id="产生问题"><a href="#产生问题" class="headerlink" title="产生问题"></a>产生问题</h3><p>在分布式(集群)环境下，每台JVM不能实现同步，在分布式场景下使用时间戳生成订单号可能会重复</p>
<h3 id="分布式情况下，解决订单号生成不重复"><a href="#分布式情况下，解决订单号生成不重复" class="headerlink" title="分布式情况下，解决订单号生成不重复"></a>分布式情况下，解决订单号生成不重复</h3><ol>
<li>使用分布式锁</li>
<li>提前生成好，订单号，存放在redis取。获取订单号，直接从redis中取。<h3 id="使用分布式锁生成订单号技术"><a href="#使用分布式锁生成订单号技术" class="headerlink" title="使用分布式锁生成订单号技术"></a>使用分布式锁生成订单号技术</h3></li>
<li>使用数据库实现分布式锁<br>缺点:性能差、线程出现异常时，容易出现死锁</li>
<li>使用redis实现分布式锁<br>缺点:锁的失效时间难控制、容易产生死锁、非阻塞式、不可重入</li>
<li>使用zookeeper实现分布式锁<br>实现相对简单、可靠性强、使用临时节点，失效时间容易控制</li>
</ol>
<h4 id="什么是分布式锁"><a href="#什么是分布式锁" class="headerlink" title="什么是分布式锁"></a>什么是分布式锁</h4><p>分布式锁一般用在分布式系统或者多个应用中，用来控制同一任务是否执行或者任务的执行顺序。在项目中，部署了多个tomcat应用，在执行定时任务时就会遇到同一任务可能执行多次的情况，我们可以借助分布式锁，保证在同一时间只有一个tomcat应用执行了定时任务</p>
<h3 id="使用Zookeeper实现分布式锁"><a href="#使用Zookeeper实现分布式锁" class="headerlink" title="使用Zookeeper实现分布式锁"></a>使用Zookeeper实现分布式锁</h3><h3 id="Zookeeper实现分布式锁原理"><a href="#Zookeeper实现分布式锁原理" class="headerlink" title="Zookeeper实现分布式锁原理"></a>Zookeeper实现分布式锁原理</h3><p>使用zookeeper创建临时序列节点来实现分布式锁，适用于顺序执行的程序，大体思路就是创建临时序列节点，找出最小的序列节点，获取分布式锁，程序执行完成之后此序列节点消失，通过watch来监控节点的变化，从剩下的节点的找到最小的序列节点，获取分布式锁，执行相应处理，依次类推……</p>
<h4 id="Maven依赖"><a href="#Maven依赖" class="headerlink" title="Maven依赖"></a>Maven依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="创建Lock接口"><a href="#创建Lock接口" class="headerlink" title="创建Lock接口"></a>创建Lock接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取到锁的资源</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getLock</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 释放锁</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建ZookeeperAbstractLock抽象类"><a href="#创建ZookeeperAbstractLock抽象类" class="headerlink" title="创建ZookeeperAbstractLock抽象类"></a>创建ZookeeperAbstractLock抽象类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将重复代码写入子类中..</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperAbstractLock</span> <span class="keyword">implements</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line">	<span class="comment">// zk连接地址</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECTSTRING = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line">	<span class="comment">// 创建zk连接</span></span><br><span class="line">	<span class="keyword">protected</span> ZkClient zkClient = <span class="keyword">new</span> ZkClient(CONNECTSTRING);</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/lock"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (tryLock()) &#123;</span><br><span class="line">			System.out.println(<span class="string">"##获取lock锁的资源####"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 等待</span></span><br><span class="line">			waitLock();</span><br><span class="line">			<span class="comment">// 重新获取锁资源</span></span><br><span class="line">			getLock();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取锁资源</span></span><br><span class="line">	<span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 等待</span></span><br><span class="line">	<span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">waitLock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (zkClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">			zkClient.close();</span><br><span class="line">			System.out.println(<span class="string">"释放锁资源..."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ZookeeperDistrbuteLock类"><a href="#ZookeeperDistrbuteLock类" class="headerlink" title="ZookeeperDistrbuteLock类"></a>ZookeeperDistrbuteLock类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperDistrbuteLock</span> <span class="keyword">extends</span> <span class="title">ZookeeperAbstractLock</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> CountDownLatch countDownLatch = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			zkClient.createEphemeral(PATH);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//			e.printStackTrace();</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">waitLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		IZkDataListener izkDataListener = <span class="keyword">new</span> IZkDataListener() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataDeleted</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				<span class="comment">// 唤醒被等待的线程</span></span><br><span class="line">				<span class="keyword">if</span> (countDownLatch != <span class="keyword">null</span>) &#123;</span><br><span class="line">					countDownLatch.countDown();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataChange</span><span class="params">(String path, Object data)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">// 注册事件</span></span><br><span class="line">		zkClient.subscribeDataChanges(PATH, izkDataListener);</span><br><span class="line">		<span class="keyword">if</span> (zkClient.exists(PATH)) &#123;</span><br><span class="line">			countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				countDownLatch.await();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 删除监听</span></span><br><span class="line">		zkClient.unsubscribeDataChanges(PATH, izkDataListener);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用Zookeeper锁运行效果"><a href="#使用Zookeeper锁运行效果" class="headerlink" title="使用Zookeeper锁运行效果"></a>使用Zookeeper锁运行效果</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> OrderNumGenerator orderNumGenerator = <span class="keyword">new</span> OrderNumGenerator();</span><br><span class="line">	<span class="comment">// 使用lock锁</span></span><br><span class="line">	<span class="comment">// private java.util.concurrent.locks.Lock lock = new ReentrantLock();</span></span><br><span class="line">	<span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ZookeeperDistrbuteLock();</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		getNumber();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			lock.getLock();</span><br><span class="line">			String number = orderNumGenerator.getNumber();</span><br><span class="line">			System.out.println(Thread.currentThread().getName() + <span class="string">",生成订单ID:"</span> + number);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			lock.unLock();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"####生成唯一订单号###"</span>);</span><br><span class="line"><span class="comment">//		OrderService orderService = new OrderService();</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">new</span> Thread( <span class="keyword">new</span> OrderService()).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/11/Mybatis-Plus%E6%9D%A1%E4%BB%B6%E6%9E%84%E9%80%A0%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/11/Mybatis-Plus%E6%9D%A1%E4%BB%B6%E6%9E%84%E9%80%A0%E5%99%A8/" class="post-title-link" itemprop="url">Mybatis-Plus条件构造器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-04-11 23:17:36 / 修改时间：23:25:35" itemprop="dateCreated datePublished" datetime="2020-04-11T23:17:36+08:00">2020-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Mybatis-Plus"><a href="#Mybatis-Plus" class="headerlink" title="Mybatis-Plus"></a>Mybatis-Plus</h1><h2 id="官方文档：-https-mp-baomidou-com-guide"><a href="#官方文档：-https-mp-baomidou-com-guide" class="headerlink" title="官方文档： https://mp.baomidou.com/guide/"></a><strong>官方文档：</strong> <a href="https://mp.baomidou.com/guide/" target="_blank" rel="noopener">https://mp.baomidou.com/guide/</a></h2><h2 id="MySQL自定义排序ORDER-BY-FIELD"><a href="#MySQL自定义排序ORDER-BY-FIELD" class="headerlink" title="MySQL自定义排序ORDER BY FIELD()"></a>MySQL自定义排序ORDER BY FIELD()</h2><p>SELECT * FROM table ORDER BY FIELD(status,1,2,0);</p>
<p>这样子写的话，返回的结果集是按照字段status的1、2、0进行排序的，当然，也可以对字符串进行排序。</p>
<p>原理如下：</p>
<p>FIELD()函数是将参数1的字段对后续参数进行比较，并返回1、2、3等等，如果遇到null或者没有在结果集上存在的数据，则返回0，然后根据升序进行排序。</p>
<h2 id="mybatis-plus一些通用方法"><a href="#mybatis-plus一些通用方法" class="headerlink" title="mybatis-plus一些通用方法"></a><a href="https://www.cnblogs.com/xiaoyinger/p/12018359.html" target="_blank" rel="noopener">mybatis-plus一些通用方法</a></h2><h2 id="wrapper介绍："><a href="#wrapper介绍：" class="headerlink" title="wrapper介绍："></a><strong>wrapper介绍：</strong></h2><ol>
<li>AbstractWrapper: 用于查询条件封装，生成sql的where条件</li>
<li>AbstractLambdaWrapper: Lambda语法使用Wrapper统一处理解析lambda获取column</li>
<li>QueryWrapper: Entity 对象封装操作类，不是用lambda</li>
<li>UpdateWrapper: Update条件封装，用于Entity对象更新操作</li>
</ol>
<h2 id="CURD接口"><a href="#CURD接口" class="headerlink" title="CURD接口"></a><strong>CURD接口</strong></h2><h3 id="Mapper-CRUD接口"><a href="#Mapper-CRUD接口" class="headerlink" title="Mapper CRUD接口"></a><strong>Mapper CRUD接口</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* <span class="keyword">int</span> insert （T entity）<span class="comment">//插入一条记录</span></span><br><span class="line">* deleteById(Serializable id) <span class="comment">//根据Id删除</span></span><br><span class="line">* deleteByMap( Map&lt;String, Object&gt; columnMap) <span class="comment">// 根据 columMap条件删除记录</span></span><br><span class="line">* <span class="keyword">int</span> delete（ Wrapper&lt;T&gt; wrapper）<span class="comment">//根据wrapper里面Entity条件删除</span></span><br><span class="line">* <span class="function"><span class="keyword">int</span> <span class="title">deleteBatchIds</span><span class="params">( Collection&lt;? extends Serializable&gt; idList)</span></span>; <span class="comment">//根据ID批量删除</span></span><br><span class="line">* <span class="function"><span class="keyword">int</span> <span class="title">updateById</span><span class="params">(T entity)</span></span>;<span class="comment">//根据ID修改</span></span><br><span class="line">* <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(T entity, Wrapper&lt;T&gt; updateWrapper)</span></span>;<span class="comment">//entity作为set条件值，</span></span><br><span class="line">* updateWrapprt里面的entity用于生成where条件值</span><br><span class="line">* <span class="function">T <span class="title">seleteById</span><span class="params">(String id)</span> <span class="comment">//根据id查询</span></span></span><br><span class="line"><span class="function">* List&lt;T&gt; <span class="title">selectBatchIds</span><span class="params">( Collection&lt;? extends Serializable&gt; idList)</span></span>;<span class="comment">//根据id批量查询</span></span><br><span class="line">* <span class="function">List&lt;T&gt; <span class="title">selectByMap</span><span class="params">( Map&lt;String, Object&gt; columnMap)</span></span>;<span class="comment">//根据map条件</span></span><br><span class="line">* <span class="function">T <span class="title">selectOne</span><span class="params">( Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//根据wrapper里面的entity查找，如果不是唯一需要添加wrapper.last("limit 1")</span></span><br><span class="line">* <span class="function">Integer <span class="title">selectCount</span><span class="params">( Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//根据wrapper条件查询总数</span></span><br><span class="line">* <span class="function">List&lt;T&gt; <span class="title">selectList</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span></span>; <span class="comment">//根据条件查询实体集合</span></span><br><span class="line">* List&lt;Map&lt;String, Object&gt;&gt; selectMaps( Wrapper&lt;T&gt; queryWrapper);<span class="comment">//根据 Wrapper 条件，查询全部记录</span></span><br><span class="line">* <span class="function">List&lt;Object&gt; <span class="title">selectObjs</span><span class="params">( Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//根据 Wrapper 条件，查询全部记录, 注意： 只返回第一个字段的值</span></span><br><span class="line">* <span class="function">Page&lt;T&gt; <span class="title">selectPage</span><span class="params">(IPage&lt;T&gt; page, Wrapper&lt;T&gt; queryWrapper)</span></span>;返回实体分页对象</span><br><span class="line">* IPage&lt;Map&lt;String, Object&gt;&gt; selectMapsPage(IPage&lt;T&gt; page, Wrapper&lt;T&gt; queryWrapper);<span class="comment">//返回字段映射对象 Map 分页对象;</span></span><br></pre></td></tr></table></figure>

<h2 id="Service-CURD接口"><a href="#Service-CURD接口" class="headerlink" title="Service CURD接口"></a><strong>Service CURD接口</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">save</span><span class="params">(T entity)</span></span>;</span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">saveBatch</span><span class="params">(Collection&lt;T&gt; entityList)</span></span>;</span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">saveBatch</span><span class="params">(Collection&lt;T&gt; entityList, <span class="keyword">int</span> batchSize)</span></span>;<span class="comment">//batchSize每次的数量</span></span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">saveOrUpdateBatch</span><span class="params">(Collection&lt;T&gt; entityList)</span></span>;<span class="comment">//批量修改插入</span></span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">saveOrUpdateBatch</span><span class="params">(Collection&lt;T&gt; entityList, <span class="keyword">int</span> batchSize)</span></span>;</span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">removeById</span><span class="params">(Serializable id)</span></span>;</span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">removeByMap</span><span class="params">(Map&lt;String, Object&gt; columnMap)</span></span>;</span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//queryWrapper 实体包装类,根据entuty条件删除</span></span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">removeByIds</span><span class="params">(Collection&lt;? extends Serializable&gt; idList)</span></span>;</span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">updateById</span><span class="params">(T entity)</span></span>;</span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">update</span><span class="params">(T entity, Wrapper&lt;T&gt; updateWrapper)</span></span>;</span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">updateBatchById</span><span class="params">(Collection&lt;T&gt; entityList, </span></span></span><br><span class="line"><span class="function"><span class="params">* <span class="keyword">int</span> batchSize)</span></span>;<span class="comment">//批量更新</span></span><br><span class="line">* <span class="function"><span class="keyword">boolean</span> <span class="title">saveOrUpdate</span><span class="params">(T entity)</span></span>;<span class="comment">//TableId 注解存在更新记录，否插入一条记录</span></span><br><span class="line">* &lt;T&gt; getById(Serializable id);<span class="comment">//根据id查询</span></span><br><span class="line">* <span class="function">Collection&lt;T&gt; <span class="title">listByIds</span><span class="params">(Collection&lt;? extends Serializable&gt; idList)</span></span>;<span class="comment">//查询（根据ID 批量查询）</span></span><br><span class="line">* <span class="function">Collection&lt;T&gt; <span class="title">listByMap</span><span class="params">(Map&lt;String, Object&gt; columnMap)</span></span>;</span><br><span class="line">* <span class="function">T <span class="title">getOne</span><span class="params">(Wrapper&lt;T&gt; queryWrapper, <span class="keyword">boolean</span> throwEx)</span></span>;<span class="comment">//throwEx 有多个 result 是否抛出异常</span></span><br><span class="line">* <span class="function">Map&lt;String, Object&gt; <span class="title">getMap</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//根据 Wrapper，查询一条记录</span></span><br><span class="line">* <span class="function">Object <span class="title">getObj</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//根据 Wrapper，查询一条记录</span></span><br><span class="line">* <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//根据 Wrapper 条件，查询总记录数</span></span><br><span class="line">* <span class="function">List&lt;T&gt; <span class="title">list</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//查询列表</span></span><br><span class="line">* <span class="function">IPage&lt;T&gt; <span class="title">page</span><span class="params">(IPage&lt;T&gt; page, Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//page为翻页对象</span></span><br><span class="line">* List&lt;Map&lt;String, Object&gt;&gt; listMaps(Wrapper&lt;T&gt; queryWrapper);<span class="comment">//查询列表</span></span><br><span class="line">* <span class="function">List&lt;Object&gt; <span class="title">listObjs</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span></span>;<span class="comment">//根据 Wrapper 条件，查询全部记录</span></span><br><span class="line">* IPage&lt;Map&lt;String, Object&gt;&gt; pageMaps(IPage&lt;T&gt; page, Wrapper&lt;T&gt; queryWrapper);</span><br></pre></td></tr></table></figure>

<h1 id="构造器方法"><a href="#构造器方法" class="headerlink" title="构造器方法"></a><strong>构造器方法</strong></h1><p><img src="/Users/panhuifang/%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0/EE33B7B6-B8A0-42E9-96A6-19C1170A11B4.png" alt="EE33B7B6-B8A0-42E9-96A6-19C1170A11B4"></p>
<h1 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a><strong>常用方法</strong></h1><h2 id="修改指定值"><a href="#修改指定值" class="headerlink" title="修改指定值"></a><strong>修改指定值</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* UpdateWrapper&lt;User&gt; userUpdateWrapper = <span class="keyword">new</span> UpdateWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">* userUpdateWrapper.eq(<span class="string">"name"</span>, <span class="string">"lqf"</span>);</span><br><span class="line"></span><br><span class="line">* <span class="keyword">int</span> update = mapper.update(user, userUpdateWrapper);</span><br></pre></td></tr></table></figure>

<h2 id="查找不为空"><a href="#查找不为空" class="headerlink" title="查找不为空"></a><strong>查找不为空</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">queryWrapper.eq(<span class="string">"name"</span>, <span class="string">"lqf"</span>);</span><br><span class="line"></span><br><span class="line">queryWrapper.isNotNull(<span class="string">"name"</span>);</span><br></pre></td></tr></table></figure>

<h2 id="查询为某列为空或等于某值-查询A列等于某值或B列等于某值"><a href="#查询为某列为空或等于某值-查询A列等于某值或B列等于某值" class="headerlink" title="查询为某列为空或等于某值/查询A列等于某值或B列等于某值"></a><strong>查询为某列为空或等于某值/查询A列等于某值或B列等于某值</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询班级Id为空或者为指定值</span></span><br><span class="line"></span><br><span class="line">query.lambda()</span><br><span class="line"></span><br><span class="line">.and(Obj -&gt;</span><br><span class="line"></span><br><span class="line">Obj.eq(User::getClazzId, (String) params.get(<span class="string">"clszzId"</span>)).or().isNull(User::getClazzId));</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询A列等于某值或B列等于某值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//（id='columnId' 'or' parent_id='columnId') and 1=1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(StringUtil.isNotBlank(columnId)) &#123;</span><br><span class="line"></span><br><span class="line">StringBuilder column = <span class="keyword">new</span> StringBuilder(<span class="string">"(id='"</span>);</span><br><span class="line"></span><br><span class="line">column.append(columnId);</span><br><span class="line"></span><br><span class="line">column.append(<span class="string">"' or "</span>);</span><br><span class="line"></span><br><span class="line">column.append(<span class="string">"parent_id = '"</span>);</span><br><span class="line"></span><br><span class="line">column.append(columnId);</span><br><span class="line"></span><br><span class="line">column.append(<span class="string">"') and 1 "</span>);</span><br><span class="line"></span><br><span class="line">query.eq(column.toString(), <span class="string">"1"</span>); <span class="comment">//自己</span></span><br></pre></td></tr></table></figure>

<h2 id="根据时间区间查询"><a href="#根据时间区间查询" class="headerlink" title="根据时间区间查询"></a><strong>根据时间区间查询</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里前端采用vue的日期时间插件将值赋给orderTime,传到后台做日期区间查询</span></span><br><span class="line"></span><br><span class="line">&lt;el-date-picker</span><br><span class="line"></span><br><span class="line">style=<span class="string">"width: 30%;margin-right: 20px"</span></span><br><span class="line"></span><br><span class="line">value-format=<span class="string">"yyyy-MM-dd"</span></span><br><span class="line"></span><br><span class="line">v-model=<span class="string">"orderTime"</span></span><br><span class="line"></span><br><span class="line">type=<span class="string">"daterange"</span></span><br><span class="line"></span><br><span class="line">range-separator=<span class="string">"-"</span></span><br><span class="line"></span><br><span class="line">start-placeholder=<span class="string">"开始日期"</span></span><br><span class="line"></span><br><span class="line">end-placeholder=<span class="string">"结束日期"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/el-date-picker&gt;</span><br><span class="line"></span><br><span class="line">AbstractWrapper query = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">String beginOrderTime = (String) params.get(<span class="string">"time[0]"</span>);</span><br><span class="line"></span><br><span class="line">String endOrderTime = (String) params.get(<span class="string">"time[1]"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StringUtil.isNotBlank(beginOrderTime) &amp;&amp; StringUtil.isNotBlank(endOrderTime)) &#123;</span><br><span class="line"></span><br><span class="line">SimpleDateFormat formatter = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line"></span><br><span class="line">Date beginTime = formatter.parse(beginOrderTime);</span><br><span class="line"></span><br><span class="line">Date endTime = formatter.parse(endOrderTime);</span><br><span class="line"></span><br><span class="line">query.between(<span class="string">"creation_time"</span>, beginTime, endTime);</span><br></pre></td></tr></table></figure>



<h2 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a><strong>批量删除</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String[] ids = ids.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; idList = Arrays.asList(ids);</span><br><span class="line"></span><br><span class="line">eventService.removeByIds(idList);</span><br></pre></td></tr></table></figure>

<h2 id="存在-不存在"><a href="#存在-不存在" class="headerlink" title="存在||不存在"></a><strong>存在||不存在</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AbstractWrapper queryTags = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">queryTags.in(<span class="string">"id"</span>, ids);</span><br><span class="line"></span><br><span class="line">List&lt;PubTag&gt; pubTagList = pubTagService.list(queryTags);</span><br></pre></td></tr></table></figure>

<h2 id="查询指定列"><a href="#查询指定列" class="headerlink" title="查询指定列"></a><strong>查询指定列</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QueryWrapper query = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line"></span><br><span class="line">query.select(<span class="string">"id"</span>, <span class="string">"name"</span>);</span><br></pre></td></tr></table></figure>



<h2 id="条件构造器使用方法"><a href="#条件构造器使用方法" class="headerlink" title="条件构造器使用方法"></a>条件构造器使用方法</h2><p><a href="https://blog.csdn.net/u013650708/article/details/89950498?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task" target="_blank" rel="noopener">https://blog.csdn.net/u013650708/article/details/89950498?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/11/Github%E4%B8%8A%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%9A%84java%E5%AD%A6%E4%B9%A0%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/11/Github%E4%B8%8A%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%9A%84java%E5%AD%A6%E4%B9%A0%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">Github上一些好的java学习项目</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-04-11 22:50:05 / 修改时间：23:00:51" itemprop="dateCreated datePublished" datetime="2020-04-11T22:50:05+08:00">2020-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Github上一些好的java学习项目"><a href="#Github上一些好的java学习项目" class="headerlink" title="Github上一些好的java学习项目"></a>Github上一些好的java学习项目</h1><h2 id="1-advanced-java"><a href="#1-advanced-java" class="headerlink" title="1. advanced-java"></a>1. <a href="https://github.com/doocs/advanced-java" target="_blank" rel="noopener">advanced-java</a></h2><ul>
<li><p>互联网 Java 工程师进阶知识完全扫盲：涵盖高并发、分布式、高可用、微服务、海量数据处理等领域知识，后端同学必看，前端同学也可学习</p>
</li>
<li><p>国内学习网站： <strong><a href="https://doocs.gitee.io/advanced-java/#/README" target="_blank" rel="noopener">https://doocs.gitee.io/advanced-java/#/README</a></strong></p>
</li>
</ul>
<h2 id="2-JavaGuide"><a href="#2-JavaGuide" class="headerlink" title="2. JavaGuide"></a>2. <a href="https://github.com/Snailclimb/JavaGuide" target="_blank" rel="noopener">JavaGuide</a></h2><ul>
<li>【Java学习+面试指南】 一份涵盖大部分Java程序员所需要掌握的核心知识</li>
<li>国内学习网站：<strong><a href="https://gitee.com/SnailClimb/JavaGuide" target="_blank" rel="noopener">https://gitee.com/SnailClimb/JavaGuide</a></strong></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/11/Feign%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/11/Feign%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Feign介绍及使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-11 22:14:39" itemprop="dateCreated datePublished" datetime="2020-04-11T22:14:39+08:00">2020-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Feign介绍及使用"><a href="#Feign介绍及使用" class="headerlink" title="Feign介绍及使用"></a>Feign介绍及使用</h1><p>feign是声明式的web service客户端，它让微服务之间的调用变得更简单了，类似controller调用service。Spring Cloud集成了Ribbon和Eureka，可在使用Feign时提供负载均衡的http客户端。</p>
<h2 id="引入Feign"><a href="#引入Feign" class="headerlink" title="引入Feign"></a><strong>引入Feign</strong></h2><p>项目中使用了gradle作为依赖管理，maven类似。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">dependencies</span> <span class="string">&#123;</span>  <span class="string">//feign</span>  <span class="string">implementation('org.springframework.cloud:spring-cloud-starter-openfeign:2.0.2.RELEASE')</span>  <span class="string">//web</span>  <span class="string">implementation('org.springframework.boot:spring-boot-starter-web')</span>  <span class="string">//eureka</span> <span class="string">client</span>  <span class="string">implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client:2.1.0.M1')</span>  <span class="string">//test</span>  <span class="string">testImplementation('org.springframework.boot:spring-boot-starter-test')&#125;</span></span><br></pre></td></tr></table></figure>

<p>因为feign底层是使用了ribbon作为负载均衡的客户端，而ribbon的负载均衡也是依赖于eureka 获得各个服务的地址，所以要引入eureka-client。</p>
<p>SpringbootApplication启动类加上@FeignClient注解，以及@EnableDiscoveryClient。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span><span class="meta">@EnableDiscoveryClient</span><span class="meta">@SpringBootApplicationpublic</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductApplication</span> </span>&#123;   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;    SpringApplication.run(ProductApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;  &#125;&#125;</span><br></pre></td></tr></table></figure>



<p>yaml配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#配置eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">status-page-url-path:</span> <span class="string">/info</span></span><br><span class="line">    <span class="attr">health-check-url-path:</span> <span class="string">/health</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#服务名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">product</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">$&#123;boot.profile:dev&#125;</span></span><br><span class="line"><span class="comment">#feign的配置，连接超时及读取超时配置</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">basic</span></span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>1234567891011121314151617181920212223242526</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="Feign的使用"><a href="#Feign的使用" class="headerlink" title="Feign的使用"></a><strong>Feign的使用</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"CART"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CartFeignClient</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/cart/&#123;productId&#125;"</span>)</span><br><span class="line">    <span class="function">Long <span class="title">addCart</span><span class="params">(@PathVariable(<span class="string">"productId"</span>)</span>Long productId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是最简单的feign client的使用，声明完为feign client后，其他spring管理的类，如service就可以直接注入使用了，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里直接注入feign client</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CartFeignClient cartFeignClient;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/toCart/&#123;productId&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">addCart</span><span class="params">(@PathVariable(<span class="string">"productId"</span>)</span> Long productId)</span>&#123;</span><br><span class="line">    Long result = cartFeignClient.addCart(productId);</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，使用feign之后，我们调用eureka 注册的其他服务，在代码中就像各个service之间相互调用那么简单。</p>
<h2 id="FeignClient注解的一些属性"><a href="#FeignClient注解的一些属性" class="headerlink" title="FeignClient注解的一些属性"></a><strong>FeignClient注解的一些属性</strong></h2><table>
<thead>
<tr>
<th>属性名</th>
<th>默认值</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>空字符串</td>
<td>调用服务名称，和name属性相同</td>
<td></td>
</tr>
<tr>
<td>serviceId</td>
<td>空字符串</td>
<td>服务id，作用和name属性相同</td>
<td>已过期</td>
</tr>
<tr>
<td>name</td>
<td>空字符串</td>
<td>调用服务名称，和value属性相同</td>
<td></td>
</tr>
<tr>
<td>url</td>
<td>空字符串</td>
<td>全路径地址或hostname，http或https可选</td>
<td></td>
</tr>
<tr>
<td>decode404</td>
<td>false</td>
<td>配置响应状态码为404时是否应该抛出FeignExceptions</td>
<td></td>
</tr>
<tr>
<td>configuration</td>
<td>{}</td>
<td>自定义当前feign client的一些配置</td>
<td>参考FeignClientsConfiguration</td>
</tr>
<tr>
<td>fallback</td>
<td>void.class</td>
<td>熔断机制，调用失败时，走的一些回退方法，可以用来抛出异常或给出默认返回数据。</td>
<td>底层依赖hystrix，启动类要加上@EnableHystrix</td>
</tr>
<tr>
<td>path</td>
<td>空字符串</td>
<td>自动给所有方法的requestMapping前加上前缀，类似与controller类上的requestMapping</td>
<td></td>
</tr>
<tr>
<td>primary</td>
<td>true</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>此外，还有qualifier及fallbackFactory，这里就不再赘述。</p>
<h2 id="Feign自定义处理返回的异常"><a href="#Feign自定义处理返回的异常" class="headerlink" title="Feign自定义处理返回的异常"></a><strong>Feign自定义处理返回的异常</strong></h2><p>这里贴上GitHub上openFeign的wiki给出的自定义errorDecoder例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StashErrorDecoder</span> <span class="keyword">implements</span> <span class="title">ErrorDecoder</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exception <span class="title">decode</span><span class="params">(String methodKey, Response response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (response.status() &gt;= <span class="number">400</span> &amp;&amp; response.status() &lt;= <span class="number">499</span>) &#123;</span><br><span class="line">            <span class="comment">//这里是给出的自定义异常</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StashClientException(</span><br><span class="line">                    response.status(),</span><br><span class="line">                    response.reason()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (response.status() &gt;= <span class="number">500</span> &amp;&amp; response.status() &lt;= <span class="number">599</span>) &#123;</span><br><span class="line">            <span class="comment">//这里是给出的自定义异常</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StashServerException(</span><br><span class="line">                    response.status(),</span><br><span class="line">                    response.reason()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这里是其他状态码处理方法</span></span><br><span class="line">        <span class="keyword">return</span> errorStatus(methodKey, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义好异常处理类后，要在@Configuration修饰的配置类中声明此类。</p>
<h2 id="Feign使用OKhttp发送request"><a href="#Feign使用OKhttp发送request" class="headerlink" title="Feign使用OKhttp发送request"></a><strong>Feign使用OKhttp发送request</strong></h2><p>Feign底层默认是使用jdk中的HttpURLConnection发送HTTP请求，feign也提供了OKhttp来发送请求，具体配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">basic</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<h2 id="Feign原理简述"><a href="#Feign原理简述" class="headerlink" title="Feign原理简述"></a><strong>Feign原理简述</strong></h2><ul>
<li>启动时，程序会进行包扫描，扫描所有包下所有@FeignClient注解的类，并将这些类注入到spring的IOC容器中。当定义的Feign中的接口被调用时，通过JDK的动态代理来生成RequestTemplate。</li>
<li>RequestTemplate中包含请求的所有信息，如请求参数，请求URL等。</li>
<li>RequestTemplate声场Request，然后将Request交给client处理，这个client默认是JDK的HTTPUrlConnection，也可以是OKhttp、Apache的HTTPClient等。</li>
<li>最后client封装成LoadBaLanceClient，结合ribbon负载均衡地发起调用。</li>
</ul>
<p>详细原理请参考源码解析。</p>
<p>Feign、hystrix与retry的关系请参考<a href="https://xli1224.github.io/2017/09/22/configure-feign/" target="_blank" rel="noopener">https://xli1224.github.io/2017/09/22/configure-feign/</a></p>
<h2 id="Feign开启GZIP压缩"><a href="#Feign开启GZIP压缩" class="headerlink" title="Feign开启GZIP压缩"></a><strong>Feign开启GZIP压缩</strong></h2><p>Spring Cloud Feign支持对请求和响应进行GZIP压缩，以提高通信效率。</p>
<p>application.yml配置信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">request:</span> <span class="comment">#请求</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启</span></span><br><span class="line">      <span class="attr">mime-types:</span> <span class="string">text/xml,application/xml,application/json</span> <span class="comment">#开启支持压缩的MIME TYPE</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">2048</span> <span class="comment">#配置压缩数据大小的下限</span></span><br><span class="line">    <span class="attr">response:</span> <span class="comment">#响应</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启响应GZIP压缩</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>由于开启GZIP压缩之后，Feign之间的调用数据通过二进制协议进行传输，返回值需要修改为ResponseEntity&lt;byte[]&gt;才可以正常显示，否则会导致服务之间的调用乱码。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/order/&#123;productId&#125;"</span>)</span><br><span class="line">ResponseEntity&lt;<span class="keyword">byte</span>[]&gt; addCart(<span class="meta">@PathVariable</span>(<span class="string">"productId"</span>) Long productId);</span><br></pre></td></tr></table></figure>



<h2 id="作用在所有Feign-Client上的配置方式"><a href="#作用在所有Feign-Client上的配置方式" class="headerlink" title="作用在所有Feign Client上的配置方式"></a><strong>作用在所有Feign Client上的配置方式</strong></h2><p>方式一：通过java bean 的方式指定。</p>
<p>@EnableFeignClients注解上有个defaultConfiguration属性，可以指定默认Feign Client的一些配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span>(defaultConfiguration = DefaultFeignConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableDiscoveryClient</span></span></span><br><span class="line"><span class="class">@<span class="title">SpringBootApplication</span></span></span><br><span class="line"><span class="class">@<span class="title">EnableCircuitBreaker</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ProductApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ProductApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DefaultFeignConfiguration内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFeignConfiguration</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Retryer <span class="title">feignRetryer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Retryer.Default(<span class="number">1000</span>,<span class="number">3000</span>,<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>方式二：通过配置文件方式指定。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span> <span class="comment">#连接超时</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span> <span class="comment">#读取超时</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">basic</span> <span class="comment">#日志等级</span></span><br></pre></td></tr></table></figure>



<h2 id="Feign-Client开启日志"><a href="#Feign-Client开启日志" class="headerlink" title="Feign Client开启日志"></a><strong>Feign Client开启日志</strong></h2><p>日志配置和上述配置相同，也有两种方式。</p>
<p>方式一：通过java bean的方式指定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFeignConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.BASIC;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>方式二：通过配置文件指定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.xt.open.jmall.product.remote.feignclients.CartFeignClient: debug</span><br></pre></td></tr></table></figure>



<h2 id="Feign-的GET的多参数传递"><a href="#Feign-的GET的多参数传递" class="headerlink" title="Feign 的GET的多参数传递"></a><strong>Feign 的GET的多参数传递</strong></h2><p>目前，feign不支持GET请求直接传递POJO对象的，目前解决方法如下：</p>
<ol>
<li>把POJO拆散城一个一个单独的属性放在方法参数中</li>
<li>把方法参数编程Map传递</li>
<li>使用GET传递@RequestBody，但此方式违反restful风格</li>
</ol>
<p>介绍一个最佳实践，通过feign的拦截器来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignCustomRequestInteceptor</span> <span class="keyword">implements</span> <span class="title">RequestInterceptor</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate template)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (HttpMethod.GET.toString() == template.method() &amp;&amp; template.body() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//feign 不支持GET方法传输POJO 转换成json，再换成query</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Map&lt;String, Collection&lt;String&gt;&gt; map = objectMapper.readValue(template.bodyTemplate(), <span class="keyword">new</span> TypeReference&lt;Map&lt;String, Collection&lt;String&gt;&gt;&gt;() &#123;</span><br><span class="line"> </span><br><span class="line">                &#125;);</span><br><span class="line">                template.body(<span class="keyword">null</span>);</span><br><span class="line">                template.queries(map);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">"cause exception"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/11/liunx%20%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/11/liunx%20%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">liunx 命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-11 22:05:10" itemprop="dateCreated datePublished" datetime="2020-04-11T22:05:10+08:00">2020-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="liunx-命令"><a href="#liunx-命令" class="headerlink" title="liunx 命令"></a>liunx 命令</h1><h2 id="1-基础命令"><a href="#1-基础命令" class="headerlink" title="1.基础命令"></a>1.基础命令</h2><p> cd usr    切换到该目录下usr目录</p>
<p>   cd ../     切换到上一层目录</p>
<p>   cd /      切换到系统根目录</p>
<p>   cd ~     切换到用户主目录</p>
<p>   cd -      切换到上一个所在目录</p>
<h3 id="1-增加目录操作（增）"><a href="#1-增加目录操作（增）" class="headerlink" title="(1)增加目录操作（增）"></a>(1)增加目录操作（增）</h3><p>命令：mkdir 目录名称</p>
<p>示例：在根目录 / 下 mkdir test，就会在根目录 / 下产生一个test问目录</p>
<h3 id="1-查看目录（查）"><a href="#1-查看目录（查）" class="headerlink" title="(1)查看目录（查）"></a>(1)查看目录（查）</h3><p>命令：ls [-al] 父目录</p>
<p>示例：在根目录 / 下使用ls，可以看到该目录下的所有的目录和文件</p>
<p>示例：在根目录 / 下使用ls，可以看到该目录下的所有的目录和文件</p>
<p>示例：在根目录 / 下使用ls -a，可以看到该目录下的所有文件和目录，包括隐藏的</p>
<p>示例：在根目录 / 下使用ls -l，可以看到该目录下的所有目录和文件的详细信息</p>
<p><strong>注意：ls -l 可以缩写成ll</strong></p>
<h3 id="1-搜索目录（查）"><a href="#1-搜索目录（查）" class="headerlink" title="(1)搜索目录（查）"></a>(1)搜索目录（查）</h3><p>命令：find 目录 参数 文件名称</p>
<p>示例：find /root -name ‘test*’</p>
<h3 id="2-修改目录的名称（改）"><a href="#2-修改目录的名称（改）" class="headerlink" title="(2)修改目录的名称（改）"></a>(2)修改目录的名称（改）</h3><p>命令：mv 目录名称 新目录名称</p>
<p>示例：test目录下有一个oldTest目录，使用mv oldTest newTest命令修改</p>
<p><strong>注意：mv的语法不仅可以对目录进行重命名而且也可以对各种文件，压缩包等进行   重命名的操作</strong></p>
<h3 id="3-移动目录的位置—剪切（改）"><a href="#3-移动目录的位置—剪切（改）" class="headerlink" title="(3)移动目录的位置—剪切（改）"></a>(3)移动目录的位置—剪切（改）</h3><p>命令：mv 目录名称 目录的新位置</p>
<p>示例：在test下将newTest目录剪切到 /usr下面，使用mv newTest /usr</p>
<p><strong>注意：mv语法不仅可以对目录进行剪切操作，对文件和压缩包等都可执行剪切操作</strong></p>
<h3 id="4-拷贝目录（改）"><a href="#4-拷贝目录（改）" class="headerlink" title="(4)拷贝目录（改）"></a>(4)拷贝目录（改）</h3><p>命令：cp -r 目录名称 目录拷贝的目标位置 —–r代表递归</p>
<p>示例：将/usr下的newTest拷贝到根目录下的test中，使用cp -r /usr/newTest /test</p>
<p><strong>注意：cp命令不仅可以拷贝目录还可以拷贝文件，压缩包等，拷贝文件和压缩包时不  用写-r递归</strong></p>
<h3 id="5-删除目录（删）"><a href="#5-删除目录（删）" class="headerlink" title="(5)删除目录（删）"></a>(5)删除目录（删）</h3><p>命令：rm [-rf] 目录</p>
<p>示例：删除/usr下的newTest，进入/usr下使用rm -r newTest</p>
<p>示例：删除/test下的newTest而不需要询问强制删除，在/test下使用rm -rf newTest</p>
<p><strong>注意：rm不仅可以删除目录，也可以删除其他文件或压缩包，为了方便大家的记忆，  无论删除任何目录或文件，都直接使用**</strong>rm -rf** <strong>目录/文件/压缩包</strong></p>
<h2 id="2．文件的操作命令（增删改查）"><a href="#2．文件的操作命令（增删改查）" class="headerlink" title="2．文件的操作命令（增删改查）"></a>2．文件的操作命令（增删改查）</h2><h3 id="1-文件的创建（增）"><a href="#1-文件的创建（增）" class="headerlink" title="(1)文件的创建（增）"></a>(1)文件的创建（增）</h3><p>命令：touch 文件名称 —– 空文件</p>
<p>示例：在test目录下创建一个空文件 touch aaa.txt</p>
<h3 id="2-文件的查看（查）"><a href="#2-文件的查看（查）" class="headerlink" title="(2)文件的查看（查）"></a>(2)文件的查看（查）</h3><p>命令：cat/more/less/tail 文件</p>
<p>示例：使用cat查看/etc/sudo.conf文件，只能显示最后一屏内容</p>
<p>示例：使用more查看/etc/sudo.conf文件，可以显示百分比，回车可以向下一行，  空格可以向下一页，q可以退出查看</p>
<p>示例：使用less查看/etc/sudo.conf文件，可以使用键盘上的PgUp和PgDn向上 和向下翻页，q结束查看</p>
<p>示例：使用tail -10 查看/etc/sudo.conf文件的后10行，Ctrl+C结束</p>
<p><strong>注意：命令 tail -f 文件 可以对某个文件进行动态监控，例如tomcat的日志文件，  会随着程序的运行，日志会变化，可以使用tail -f catalina-2016-11-11.log 监控   文 件的变化</strong></p>
<h3 id="3-修改文件的内容（改）"><a href="#3-修改文件的内容（改）" class="headerlink" title="(3)修改文件的内容（改）"></a>(3)修改文件的内容（改）</h3><p>命令：vim 文件</p>
<p>示例：编辑/test下的aaa.txt文件，使用vim aaa.txt</p>
<p>但此时并不能编辑，因为此时处于命令模式，点击键盘i/a/o进入编辑模式，可以  编辑文件</p>
<p>编辑完成后，按下Esc，退回命令模式</p>
<p>此时文件虽然已经编辑完成，但是没有保存，需输入冒号：进入底行模式，在底行模   式下输入wq代表写入内容并退出，即保存；输入q!代表强制退出不保存。</p>
<p><strong>总结：</strong></p>
<p>vim编辑器是Linux中的强大组件，是vi编辑器的加强版，vim编辑器的命令和快捷方式有很多，但此处不一一阐述，大家也无需研究的很透彻，使用vim编辑修改文件的方式基本会使用就可以了。</p>
<p>关于vim使用过程：</p>
<p>vim 文件——–&gt;命令模式———&gt;输入i———-&gt;编辑模式———–&gt;编辑文件———–&gt;按下Esc———&gt;命令模式———&gt;按下：———-&gt;底行模式———–&gt;输入wq保存并退出/q！强制退出不保存</p>
<h3 id="4-删除文件（删）"><a href="#4-删除文件（删）" class="headerlink" title="(4)删除文件（删）"></a>(4)删除文件（删）</h3><p>同目录删除：熟记 rm -rf 文件 即可</p>
<h2 id="3．压缩文件的操作命令"><a href="#3．压缩文件的操作命令" class="headerlink" title="3．压缩文件的操作命令"></a>3．压缩文件的操作命令</h2><h3 id="1-打包并压缩文件"><a href="#1-打包并压缩文件" class="headerlink" title="(1)打包并压缩文件"></a>(1)打包并压缩文件</h3><p>Windows的压缩文件的扩展名 .zip/.rar</p>
<p>linux中的打包文件：.tar</p>
<p>linux中的压缩文件：.gz</p>
<p>linux中打包并压缩的文件：.tar.gz</p>
<p>Linux中的打包文件一般是以.tar结尾的，压缩的命令一般是以.gz结尾的。</p>
<p>而一般情况下打包和压缩是一起进行的，打包并压缩后的文件的后缀名一般.tar.gz。</p>
<p>命令：tar -zcvf 打包压缩后的文件名 要打包的文件</p>
<p>其中：z：调用gzip压缩命令进行压缩</p>
<p>c：打包文件</p>
<p>v：显示运行过程</p>
<p>f：指定文件名</p>
<p>示例：打包并压缩/test下的所有文件 压缩后的压缩包指定名称为xxx.tar.gz</p>
<p>tar -zcvf xxx.tar.gz aaa.txt bbb.txt ccc.txt</p>
<p>或：tar -zcvf xxx.tar.gz /test/*</p>
<h3 id="2-解压压缩包（重点）"><a href="#2-解压压缩包（重点）" class="headerlink" title="(2)解压压缩包（重点）"></a>(2)解压压缩包<strong>（重点）</strong></h3><p>命令：tar [-xvf] 压缩文件</p>
<p>其中：x：代表解压</p>
<p>示例：将/test下的xxx.tar.gz解压到当前目录下</p>
<p>tar -xvf xxx.tar.gz</p>
<p>示例：将/test下的xxx.tar.gz解压到根目录/usr下</p>
<p><strong>tar -xvf xxx.tar.gz -C /usr——C**</strong>代表指定解压的位置**</p>
<h2 id="4．其他命令"><a href="#4．其他命令" class="headerlink" title="4．其他命令"></a>4．其他命令</h2><h3 id="1-显示工作目录"><a href="#1-显示工作目录" class="headerlink" title="(1)显示工作目录"></a>(1)显示工作目录</h3><p>命令：pwd</p>
<h3 id="2-查看进程"><a href="#2-查看进程" class="headerlink" title="(2)查看进程"></a>(2)查看进程</h3><p>命令：ps -ef —显示所有的进程</p>
<h3 id="3-kill命令"><a href="#3-kill命令" class="headerlink" title="(3)kill命令"></a>(3)kill命令</h3><p>命令：kill -9 pid（pid是进程的id）</p>
<h3 id="4-搜索命令"><a href="#4-搜索命令" class="headerlink" title="(4)搜索命令"></a>(4)搜索命令</h3><p>命令：grep 要搜索的字符串 要搜索的文件</p>
<p>示例：搜索/usr/sudu.conf文件中包含字符串to的行</p>
<p>示例：搜索/usr/sudu.conf文件中包含字符串to的行 to要高亮显示</p>
<h3 id="5-管道命令"><a href="#5-管道命令" class="headerlink" title="(5)管道命令"></a>(5)管道命令</h3><p>命令：|  将前一个命令的输出作为本次目录的输入</p>
<p>示例：查看当前系统中所有的进程中包括system字符串的进程</p>
<h3 id="6-网络通信命令"><a href="#6-网络通信命令" class="headerlink" title="(6)网络通信命令"></a>(6)网络通信命令</h3><p>查看当前系统的网卡信息：ifconfig</p>
<p>查看与某台机器的连接情况：ping</p>
<p>查看当前系统的端口使用：netstat -an</p>
<h3 id="7-关机命令"><a href="#7-关机命令" class="headerlink" title="(7)关机命令"></a>(7)关机命令</h3><p>重启命令：reboot</p>
<p>立即关机：halt</p>
<h2 id="5．Linux的权限命令"><a href="#5．Linux的权限命令" class="headerlink" title="5．Linux的权限命令"></a>5．Linux的权限命令</h2><p>权限是Linux中的重要概念，每个文件/目录等都具有权限，通过ls -l命令我们可以 查看某个目录下的文件或目录的权限</p>
<p>示例：在随意某个目录下ls -l</p>
<p>第一列的内容的信息解释如下：</p>
<p>文件的类型：</p>
<p>d：代表目录</p>
<p>-：代表文件</p>
<p>l：代表链接（可以认为是window中的快捷方式）</p>
<p>后面的9位分为3组，每3位置一组，分别代表属主的权限，与当前用户同组的   用户的权限，其他用户的权限</p>
<p>r：代表权限是可读，r也可以用数字4表示</p>
<p>w：代表权限是可写，w也可以用数字2表示</p>
<p>x：代表权限是可执行，x也可以用数字1表示</p>
<table>
<thead>
<tr>
<th><strong>属主（user</strong>）</th>
<th></th>
<th></th>
<th><strong>属组（<em>group</em>）</strong></th>
<th></th>
<th></th>
<th><strong>其他用户</strong></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>r</td>
<td>w</td>
<td>x</td>
<td>r</td>
<td>w</td>
<td>x</td>
<td>r</td>
<td>w</td>
<td>x</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>1</td>
<td>4</td>
<td>2</td>
<td>1</td>
<td>4</td>
<td>2</td>
<td>1</td>
</tr>
</tbody></table>
<p>修改文件/目录的权限的命令：chmod</p>
<p>示例：修改/test下的aaa.txt的权限为属主有全部权限，属主所在的组有读写权限，</p>
<p>其他用户只有读的权限</p>
<p>chmod u=rwx,g=rw,o=r aaa.txt</p>
<p>上述示例还可以使用数字表示：</p>
<p>chmod 764 aaa.txt</p>
<h1 id="二、远程连接工具的使用"><a href="#二、远程连接工具的使用" class="headerlink" title="二、远程连接工具的使用"></a>二、远程连接工具的使用</h1><p>实际开发中，Linux服务器都在其他的地方，我们要通过远程的方式去连接Linux并操作它，Linux远程的操作工具有很多，企业中常用的有Puttty、secureCRT、SSH Secure等。课程中我们使用SSH Secure工具进行远程连接，该工具是免费的图形化界面及命令行窗口集一身的远程工具。安装包如下：</p>
<p>安装后，会出现两个图标：</p>
<p>点击图形化界面图标：</p>
<p>进入界面：</p>
<p>关于远程工具乱码的解决：</p>
<p>使用远程工具进行连接时，如果linux有中文文件或目录，显示时会出现乱码，原因是linux编码是UTF-8，而远程工具默认是当前系统本地编码即GBK。所以解决方案是统一两者编码就OK了，但是该SSH Secure工具不能设置编码，所以通过修改linux的系统编码的方式进行统一编码。</p>
<p>在linux的/etc/sysconfig目录下有一个i18n的文件代表linux的系统编码</p>
<p>将其从UTF-8修改成GBK重现连接linux即可：</p>
<h1 id="三、Linux的软件安装"><a href="#三、Linux的软件安装" class="headerlink" title="三、Linux的软件安装"></a>三、Linux的软件安装</h1><h3 id="1．JDK安装"><a href="#1．JDK安装" class="headerlink" title="1．JDK安装"></a>1．JDK安装</h3><p>注意：rpm与软件相关命令 相当于window下的软件助手 管理软件</p>
<p>步骤：</p>
<p>1）查看当前Linux系统是否已经安装java</p>
<p>输入 rpm -qa | grep java</p>
<p>2）卸载两个openJDK</p>
<p>输入rpm -e –nodeps 要卸载的软件</p>
<p> 3）上传jdk到linux</p>
<p>4）解压jdk到/usr/local下 tar –xvf jdk-7u71-linux-i586.tar.gz –C /usr/local</p>
<p>5）配置jdk环境变量，打开/etc/profile配置文件，将下面配置拷贝进去</p>
<p>   #set java environment</p>
<p>   JAVA_HOME=/usr/local/jdk1.7.0_71</p>
<p>   CLASSPATH=.:$JAVA_HOME/lib.tools.jar</p>
<p>   PATH=$JAVA_HOME/bin:$PATH</p>
<p>   export JAVA_HOME CLASSPATH PATH</p>
<p>6）重新加载/etc/profile配置文件 source /etc/profile</p>
<p> 2．Mysql安装</p>
<p>步骤：</p>
<p>1）查看CentOS自带的mysql</p>
<p>输入 rpm -qa | grep mysql</p>
<p>2）将自带的mysql卸载</p>
<p>3）上传Mysql到linux</p>
<p>4）解压Mysql到/usr/local/下的mysql目录(mysql目录需要手动创建)内</p>
<p>cd /usr/local</p>
<p>mkdir mysql</p>
<p>tar -xvf MySQL-5.6.22-1.el6.i686.rpm-bundle.tar -C /usr/local/mysql</p>
<p>5）在/usr/local/mysql下安装mysql</p>
<p>安装服务器端：rpm -ivh MySQL-server-5.6.22-1.el6.i686.rpm</p>
<p>安装客户端：rpm -ivh MySQL-client-5.6.22-1.el6.i686.rpm</p>
<p>6）启动mysql</p>
<p>service mysql start</p>
<p>7）将mysql加到系统服务中并设置开机启动</p>
<p>加入到系统服务：chkconfig –add mysql</p>
<p>自动启动：chkconfig mysql on</p>
<p>8）登录mysql</p>
<p>mysql安装好后会生成一个临时随机密码，存储位置在/root/.mysql_secret</p>
<p> msyql –u root -p</p>
<p>9）修改mysql的密码</p>
<p>set password = password(‘root’);</p>
<p>10）开启mysql的远程登录</p>
<p>默认情况下mysql为安全起见，不支持远程登录mysql，所以需要设置开启   远程登录mysql的权限</p>
<p>登录mysql后输入如下命令：</p>
<p>grant all privileges on <em>.</em> to ‘root’ @’%’ identified by ‘root’;</p>
<p>flush privileges;</p>
<p>11）开放Linux的对外访问的端口3306</p>
<p>/sbin/iptables -I INPUT -p tcp –dport 3306 -j ACCEPT</p>
<p>/etc/rc.d/init.d/iptables save —将修改永久保存到防火墙中</p>
<p>3．Tomcat安装</p>
<p>步骤：</p>
<p>1）上传Tomcat到linux上</p>
<p>2）解压Tomcat到/usr/local下</p>
<p>3）开放Linux的对外访问的端口8080</p>
<p>/sbin/iptables -I INPUT -p tcp –dport 8080 -j ACCEPT</p>
<p>/etc/rc.d/init.d/iptables save</p>
<p>4）启动关闭Tomcat</p>
<p>进入tomcat的bin下启动：./startup.sh</p>
<p>进入tomcat的bin下关闭：./shutdown.sh</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/11/%E4%BD%BF%E7%94%A8EasyExcel%20%E8%AF%BB%E5%8F%96excel%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/11/%E4%BD%BF%E7%94%A8EasyExcel%20%E8%AF%BB%E5%8F%96excel%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">使用EasyExcel 读取excel方式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-04-11 21:44:17 / 修改时间：21:44:18" itemprop="dateCreated datePublished" datetime="2020-04-11T21:44:17+08:00">2020-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用EasyExcel-读取excel方式"><a href="#使用EasyExcel-读取excel方式" class="headerlink" title="使用EasyExcel 读取excel方式"></a>使用EasyExcel 读取excel方式</h1><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p><a href="https://alibaba-easyexcel.github.io/quickstart/read.html" target="_blank" rel="noopener">https://alibaba-easyexcel.github.io/quickstart/read.html</a></p>
<h2 id="一个demo"><a href="#一个demo" class="headerlink" title="一个demo"></a>一个demo</h2><p><a href="https://www.cnblogs.com/oukele/p/11443659.html" target="_blank" rel="noopener">https://www.cnblogs.com/oukele/p/11443659.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/11/Lombok%20%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/11/Lombok%20%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/" class="post-title-link" itemprop="url">Lombok 介绍及常用注解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-11 21:35:46" itemprop="dateCreated datePublished" datetime="2020-04-11T21:35:46+08:00">2020-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Lombok-介绍"><a href="#Lombok-介绍" class="headerlink" title="Lombok 介绍"></a>Lombok 介绍</h1><h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h2><p>在项目中使用Lombok可以减少很多重复代码的书写。比如说getter/setter/toString等方法的编写。</p>
<h2 id="2-IDEA中的安装"><a href="#2-IDEA中的安装" class="headerlink" title="2.IDEA中的安装"></a>2.IDEA中的安装</h2><p>打开IDEA的Setting –&gt; 选择Plugins选项 –&gt; 选择Browse repositories –&gt; 搜索lombok –&gt; 点击安装 –&gt; 安装完成重启IDEA –&gt; 安装成功</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a54370fab644126e2000c44" alt="idea安装Lombok"></p>
<h2 id="3-引入依赖"><a href="#3-引入依赖" class="headerlink" title="3.引入依赖"></a>3.引入依赖</h2><p>在项目中添加Lombok依赖jar，在pom文件中添加如下部分。(不清楚版本可以在<a href="http://mvnrepository.com/" target="_blank" rel="noopener">Maven仓库</a>中搜索)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https:&#x2F;&#x2F;mvnrepository.com&#x2F;artifact&#x2F;org.projectlombok&#x2F;lombok --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.16.18&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;scope&gt;provided&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-使用"><a href="#4-使用" class="headerlink" title="4.使用"></a>4.使用</h2><p>在对应的类或者方法上使用对应注解即可</p>
<h2 id="5-Lombok常用注解"><a href="#5-Lombok常用注解" class="headerlink" title="5.Lombok常用注解"></a>5.Lombok常用注解</h2><ul>
<li>@Setter<br>@Getter<br>@Data<br>@Log(这是一个泛型注解，具体有很多种形式)<br>@AllArgsConstructor<br>@NoArgsConstructor<br>@EqualsAndHashCode<br>@NonNull<br>@Cleanup<br>@ToString<br>@RequiredArgsConstructor<br>@Value<br>@SneakyThrows<br>@Synchronized</li>
</ul>
<h2 id="6-注解详情"><a href="#6-注解详情" class="headerlink" title="6.注解详情"></a>6.注解详情</h2><h3 id="6-1-log"><a href="#6-1-log" class="headerlink" title="6.1 log"></a>6.1 log</h3><p>注解在 <strong>类</strong> 上。有如下可选择可用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@CommonsLog</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.commons.logging.Log log = org.apache.commons.logging.LogFactory.getLog(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//@JBossLog</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.jboss.logging.Logger log = org.jboss.logging.Logger.getLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//@Log</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.util.logging.Logger log = java.util.logging.Logger.getLogger(LogExample<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line"><span class="comment">//@Log4j</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//@Log4j2</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.logging.log4j.Logger log = org.apache.logging.log4j.LogManager.getLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//@Slf4j</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//@XSlf4j</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.ext.XLogger log = org.slf4j.ext.XLoggerFactory.getXLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>默认情况下，记录器的主题（或名称）将是使用注释进行<code>@Log</code>注释的类的类名称。这可以通过指定<code>topic</code>参数来定制。例如：<code>@XSlf4j(topic=&quot;reporting&quot;)</code>。</p>
<p>该类型注解可以满足不同的日志系统的日志使用，Lombok提供了一些自定义配置项可以参看官方说明文档。</p>
<p><a href="https://projectlombok.org/features/log" target="_blank" rel="noopener">Log官方介绍</a></p>
<h3 id="6-2-Getter和-Setter"><a href="#6-2-Getter和-Setter" class="headerlink" title="6.2 @Getter和@Setter"></a>6.2 @Getter和@Setter</h3><p>该注解使用在<strong>类或者属性</strong>上，该注解可以使用在类上也可以使用在属性上。生成的getter遵循布尔属性的约定。例如：boolean类型的sex,getter方法为<code>isSex</code>而不是<code>getSex</code></p>
<p>在使用该注解时，会默认生成一个无参构造。和对应的getterhe setter方法</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a54370fab644126e2000c49" alt="img"></p>
<p>该注解也可以使用在单个属性上，会默认生成一个无参构造：</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a54370fab644126e2000c48" alt="img"></p>
<h3 id="6-3-Data"><a href="#6-3-Data" class="headerlink" title="6.3 @Data"></a>6.3 @Data</h3><p>该注解使用在类上，该注解是最常用的注解，它结合了@ToString，@EqualsAndHashCode， @Getter和@Setter。本质上使用@Data注解，类默认@ToString和@EqualsAndHashCode以及每个字段都有@Setter和@getter。该注解也会生成一个公共构造函数，可以将任何@NonNull和final字段作为参数。</p>
<p>虽然<code>@Data</code>注解非常有用，但是它没有与其他注解相同的控制粒度。<code>@Data</code>提供了一个可以生成静态工厂的单一参数，将<code>staticConstructor</code>参数设置为所需要的名称，Lombok自动生成的构造函数设置为私有，并提供公开的给定名称的静态工厂方法。<br><img src="https://leanote.com/api/file/getImage?fileId=5a546265ab644126e2001263" alt="示例"></p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a54370fab644126e2000c43" alt="img"></p>
<h3 id="6-4-NonNull"><a href="#6-4-NonNull" class="headerlink" title="6.4 @NonNull"></a>6.4 @NonNull</h3><p>该注解使用在<strong>属性</strong>上，该注解用于属的非空检查，当放在setter方法的字段上，将生成一个空检查，如果为空，则抛出<code>NullPointerException</code>。<br>该注解会默认是生成一个无参构造。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a54370fab644126e2000c47" alt="img"></p>
<h3 id="6-5-toString"><a href="#6-5-toString" class="headerlink" title="6.5 @toString"></a>6.5 @toString</h3><p>该注解使用在类上，该注解默认生成任何非讲台字段以名称-值的形式输出。<br>1、如果需要可以通过注释参数includeFieldNames来控制输出中是否包含的属性名称。<br>2、可以通过exclude参数中包含字段名称，可以从生成的方法中排除特定字段。<br>3、可以通过callSuper参数控制父类的输出。</p>
<ul>
<li><p>includeFieldNames是否包含属性名称：<br><img src="https://leanote.com/api/file/getImage?fileId=5a54370fab644126e2000c45" alt="示例"></p>
</li>
<li><p>exclude 排除指定字段</p>
</li>
<li><p>callSuper输出父类属性</p>
</li>
</ul>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a543c1aab644126e2000d38" alt="示例"></p>
<p>注意：父类也要有toString方法，不然打印的是对象内存地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//父类无toString方法</span></span><br><span class="line">Person(<span class="keyword">super</span>=com.motui.Person@<span class="number">3</span>abfe836, firstName=motui, address=北京, dateOfBirth=Tue Jan <span class="number">09</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">05</span> CST <span class="number">2018</span>, sex=<span class="keyword">true</span>)</span><br><span class="line"><span class="comment">//父类有toString方法</span></span><br><span class="line">Person(<span class="keyword">super</span>=People(id=<span class="number">111</span>), firstName=motui, address=北京, dateOfBirth=Tue Jan <span class="number">09</span> <span class="number">11</span>:<span class="number">50</span>:<span class="number">11</span> CST <span class="number">2018</span>, sex=<span class="keyword">true</span>)</span><br></pre></td></tr></table></figure>

<h3 id="6-5-EqualsAndHashCode"><a href="#6-5-EqualsAndHashCode" class="headerlink" title="6.5 @EqualsAndHashCode"></a>6.5 @EqualsAndHashCode</h3><p>该注解使用在<strong>类</strong>上，该注解在类级别注释会同时生成<code>equals</code>和<code>hashCode</code>。<br>注意继承关系的时候该注解的使用。详细介绍参照<a href="http://jnb.ociweb.com/jnb/jnbJan2010.html" target="_blank" rel="noopener">官方介绍</a></p>
<p>存在继承关系需要设置<code>callSuper</code>参数为<code>true</code>。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a543f5dab644126e2000d85" alt="示例"></p>
<h3 id="6-6-AllArgsConstructor"><a href="#6-6-AllArgsConstructor" class="headerlink" title="6.6 @AllArgsConstructor"></a>6.6 @AllArgsConstructor</h3><p>该注解使用在<strong>类</strong>上，该注解提供一个全参数的构造方法，默认不提供无参构造。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a546265ab644126e2001260" alt="img"></p>
<h3 id="6-7-NoArgsConstructor"><a href="#6-7-NoArgsConstructor" class="headerlink" title="6.7 @NoArgsConstructor"></a>6.7 @NoArgsConstructor</h3><p>该注解使用在<strong>类</strong>上，该注解提供一个无参构造</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a546266ab644126e2001264" alt="示例"></p>
<h3 id="6-8-RequiredArgsConstructor"><a href="#6-8-RequiredArgsConstructor" class="headerlink" title="6.8 @RequiredArgsConstructor"></a>6.8 @RequiredArgsConstructor</h3><p>该注解使用在<strong>类</strong>上，使用类中所有带有 @NonNull 注解的或者带有 final 修饰的成员变量生成对应的构造方法。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a546265ab644126e200125f" alt="实例"></p>
<h3 id="6-9-Value"><a href="#6-9-Value" class="headerlink" title="6.9 @Value"></a>6.9 @Value</h3><p>这个注解用在 类 上，会生成含所有参数的构造方法，get 方法，此外还提供了equals、hashCode、toString 方法。<br><strong>注意：没有setter</strong></p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a546265ab644126e2001261" alt="示例"></p>
<h3 id="6-10-Cleanup"><a href="#6-10-Cleanup" class="headerlink" title="6.10 @Cleanup"></a>6.10 @Cleanup</h3><p>该注解使用在<strong>属性</strong>前，该注解是用来保证分配的资源被释放。在本地变量上使用该注解，任何后续代码都将封装在try/finally中，确保当前作用于中的资源被释放。默认<code>@Cleanup</code>清理的方法为<code>close</code>，可以使用value指定不同的方法名称。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a546266ab644126e2001266" alt="示例"></p>
<h3 id="6-11-Synchronized"><a href="#6-11-Synchronized" class="headerlink" title="6.11 @Synchronized"></a>6.11 @Synchronized</h3><p>该注解使用在类或者实例方法上，Synchronized在一个方法上，使用关键字可能会导致结果和想要的结果不同，因为多线程情况下会出现异常情况。Synchronized<br>关键字将在this示例方法情况下锁定当前对象，或者class讲台方法的对象上多锁定。这可能会导致死锁现象。一般情况下建议锁定一个专门用于此目的的独立锁，而不是允许公共对象进行锁定。该注解也是为了达到该目的。<br><img src="https://leanote.com/api/file/getImage?fileId=5a546265ab644126e2001262" alt="示例"></p>
<h3 id="6-12-SneakyThrows"><a href="#6-12-SneakyThrows" class="headerlink" title="6.12 @SneakyThrows"></a>6.12 @SneakyThrows</h3><p>该注解使用在<strong>方法</strong>上，这个注解用在 方法 上，可以将方法中的代码用 try-catch 语句包裹起来，捕获异常并在 catch 中用 </p>
<p>Lombok.sneakyThrow(e) 把异常抛出，可以使用 @SneakyThrows(Exception.class) 的形式指定抛出哪种异常。该注解需要谨慎使用。详情参看<a href="https://projectlombok.org/features/SneakyThrows" target="_blank" rel="noopener">官方介绍</a></p>
<p><img src="https://leanote.com/api/file/getImage?fileId=5a546266ab644126e2001265" alt="示例"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/11/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhanglu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhanglu的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/11/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-11 20:42:21" itemprop="dateCreated datePublished" datetime="2020-04-11T20:42:21+08:00">2020-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhanglu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhanglu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
